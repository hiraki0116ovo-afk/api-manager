<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>API Key ç®¡ç†å™¨</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #F2F2F7;
            --bg-tertiary: #F2F2F7;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #e0e0e0;
            --accent: #007AFF;
            --warning: #FF3B30;
            --success: #34C759;
            /* æ”¹äº†æ•°å€¼ */
            --card-radius: 20px;
            --btn-radius: 14px;
            --input-radius: 12px;
            --modal-radius: 24px;
            /* åˆ°è¿™ */
        }

        /* æ”¹äº†èƒŒæ™¯é¢œè‰² */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            /* ğŸŸ¢ æ¢¦å¹»æ£‰èŠ±ç³–æ¸å˜ï¼šä»æµ…ç²‰è¿‡æ¸¡åˆ°æ·¡ç´« */
            background: linear-gradient(135deg, #edffff 0%, #FFE4E1 50%, #f1f1ff 100%);
            background-attachment: fixed;
            /* æ»‘åŠ¨é¡µé¢æ—¶èƒŒæ™¯ä¸åŠ¨ï¼Œè´¨æ„Ÿæ‹‰æ»¡ */
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* åˆ°è¿™ */
        /* å¢åŠ æ¯›ç»ç’ƒæ•ˆæœ */
        /* ğŸŸ¢ è®©æ‰€æœ‰å¡ç‰‡å˜æˆåŠé€æ˜çš„æ¯›ç»ç’ƒï¼Œå¹¶åŠ ä¸Šæ·¡æ·¡çš„ç²‰è‰²å‘¼å¸é˜´å½± */
        .overview-card,
        .overview-item,
        .section-card,
        .home-card,
        .settings-item,
        .platform-header,
        .key-item {
            background: rgba(255, 255, 255, 0.7) !important;
            /* åŠé€æ˜ç™½è‰² */
            backdrop-filter: blur(12px);
            /* è‹¹æœé£æ¯›ç»ç’ƒ */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            /* è¾¹ç¼˜é«˜å…‰ */
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.06) !important;
            /* ç”œç¾çš„æµ…ç²‰é˜´å½± */
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
            /* Qå¼¹çš„åŠ¨ç”»æ›²çº¿ */
        }

        /* ğŸŸ¢ è½»è½»æŒ‰ä½å¡ç‰‡æ—¶ï¼Œä¼šæœ‰å¯çˆ±çš„ç¼©æ”¾ååº” */
        .overview-item:active,
        .home-card:active,
        .settings-item:active,
        .header-btn.circular:active {
            transform: scale(0.92);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.04) !important;
        }

        /* åˆ°è¿™ */


        #app {
            min-height: 100vh;
        }

        .svg-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }

        .svg-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .svg-icon.small {
            width: 16px;
            height: 16px;
        }

        .svg-icon.large {
            width: 32px;
            height: 32px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px 16px;
            cursor: pointer;
            color: var(--text-tertiary);
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 11px;
        }

        .page {
            padding: 16px;
            padding-bottom: 80px;
            max-width: 600px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 8px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: var(--btn-radius);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ğŸŸ¢ åœ†å½¢æŒ‰é’®å‡çº§ç‰ˆï¼šæ¯›ç»ç’ƒ + è·Ÿéšä¸»é¢˜è‰² */
        .header-btn.circular {
    border-radius: 50%;
    width: 38px; /* ç”µè„‘ç«¯ç¨å¤§ä¸€ç‚¹ */
    height: 38px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.9) !important;
    color: var(--accent) !important;
    border: 2px solid white;
    box-shadow: 0 4px 12px rgba(255, 105, 180, 0.15);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* ğŸŸ¢ æ‰‹æœºç«¯è‡ªé€‚åº”ï¼šå±å¹•å®½åº¦å°äº 480px æ—¶å˜å° */
@media (max-width: 480px) {
    .header-btn.circular {
        width: 32px;
        height: 32px;
    }
    .header-btn.circular .svg-icon {
        width: 18px; /* å›¾æ ‡ä¹Ÿè·Ÿç€ç¼©ä¸€ç‚¹ */
        height: 18px;
    }
}

        /* åˆ°è¿™ */


        /* å¢åŠ äº†ç‰¹æ•ˆ */
        /* ğŸŸ¢ ç‚¹å‡»æ‰è½è¡¨æƒ…åŒ…çš„ä¸“å±ç‰¹æ•ˆ */
        @keyframes floatUpEmoji {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }

            50% {
                transform: translateY(-30px) scale(1.2);
                opacity: 0.8;
            }

            100% {
                transform: translateY(-60px) scale(1);
                opacity: 0;
            }
        }

        .magic-emoji {
            position: fixed;
            pointer-events: none;
            /* ä¿è¯å®ƒåªæ˜¯ä¸ªç‰¹æ•ˆï¼Œä¸ä¼šæŒ¡ä½ä½ ç‚¹åˆ«çš„æŒ‰é’® */
            z-index: 9999;
            animation: floatUpEmoji 0.8s ease-out forwards;
            font-size: 22px;
            user-select: none;
        }

        /* åˆ°è¿™ */

        .header-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-actions .header-btn {
            width: auto;
            padding: 0 12px;
            font-size: 14px;
        }

        .stats-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            margin-bottom: 20px;
        }

        .stats-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-title {
            font-size: 15px;
            font-weight: 500;
        }

        .stats-period {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 16px;
            gap: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .stat-value.warning {
            color: var(--warning);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .stats-list {
            padding: 0 16px 16px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-row-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stats-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }

        .stats-dot.warning {
            background: var(--warning);
        }

        .stats-name {
            font-size: 14px;
        }

        .stats-amount {
            font-size: 14px;
            font-weight: 500;
        }

        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .home-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
        }

        .home-card-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .home-card-title {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .home-card-desc {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .platform-section {
            margin-bottom: 16px;
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: var(--card-radius);
            margin-bottom: 8px;
        }

        .platform-name {
            font-size: 14px;
            font-weight: 500;
        }

        .platform-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .key-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .key-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 12px;
        }

        .key-item.warning {
            border-left: 3px solid var(--warning);
        }

        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .key-title {
            font-size: 14px;
            font-weight: 500;
        }

        .key-menu {
            font-size: 18px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0 4px;
        }

        .key-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .key-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .key-masked {
            font-family: monospace;
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .balance-bar {
            width: 50px;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
        }

        .balance-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
        }

        .balance-fill.warning {
            background: var(--warning);
        }

        .key-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tag {
            font-size: 10px;
            padding: 1px 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .key-actions {
            display: flex;
            gap: 4px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .key-note-area {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .note-display {
            font-size: 12px;
            color: var(--text-secondary);
            min-height: 20px;
            cursor: pointer;
            padding: 4px;
            line-height: 1.5;
        }

        .note-display:hover {
            background: var(--bg-secondary);
        }

        .note-input {
            width: 100%;
            border: 1px solid var(--accent);
            border-radius: var(--input-radius);
            padding: 6px;
            font-size: 12px;
            resize: none;
            font-family: inherit;
            min-height: 60px;
        }

        .note-input:focus {
            outline: none;
        }

        .key-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: var(--btn-radius);
            font-size: 11px;
            cursor: pointer;
        }

        .key-btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin: 0 -4px 16px;
            padding: 4px 4px 8px;
            overflow-x: auto;
            background: var(--bg-secondary);
            border-radius: var(--card-radius);
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: var(--btn-radius);
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
        }

        /* ğŸŸ¢ ä¿®å¤ç®¡ç†é¡µçš„åˆ†ç±»æŒ‰é’® */
        .filter-btn {
            color: var(--text-secondary) !important; /* æœªé€‰ä¸­æ—¶æ˜¯æ¸…æ™°çš„æµ…ç°è‰² */
        }
        
        /* é€‰ä¸­çš„æŒ‰é’®å˜æˆåŠé€æ˜æœå†»è‰²ï¼Œæ–‡å­—å˜æˆä½ çš„ä¸“å±ä¸»é¢˜è‰² */
        .filter-btn.active {
            background: rgba(255, 255, 255, 0.6) !important; /* æ”¹æˆ 0.6 çš„åŠé€æ˜ç™½ï¼Œä¸çªå…€ */
            color: var(--accent) !important; /* æ–‡å­—è·Ÿéšç²‰è‰²ä¸»é¢˜è‰²ï¼ */
            box-shadow: 0 2px 8px rgba(255, 105, 180, 0.15); /* æ·¡æ·¡çš„ç²‰è‰²å‘å…‰ */
            font-weight: 700;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chart-container {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 16px;
            height: 280px;
            margin-bottom: 16px;
        }

        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chart-tab {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            border-radius: var(--btn-radius);
            font-size: 12px;
            cursor: pointer;
        }

        .chart-tab.active {
            background: var(--accent);
            color: white;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-primary);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--input-radius);
            background: var(--bg-primary);
            min-height: 46px;
            align-items: center;
        }

        .tag-input input {
            border: none;
            flex: 1;
            min-width: 80px;
            font-size: 14px;
        }

        .tag-input input:focus {
            outline: none;
        }

        .tag-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 12px;
        }

        .tag-remove {
            cursor: pointer;
            color: var(--text-tertiary);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .collapse-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            cursor: pointer;
            margin-bottom: 16px;
        }

        .collapse-title {
            font-size: 14px;
            font-weight: 500;
        }

        .collapse-arrow {
            font-size: 16px;
            color: var(--text-tertiary);
            transition: transform 0.2s;
        }

        .collapse-arrow.expanded {
            transform: rotate(90deg);
        }

        .advanced-options {
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
        }

        .limit-reminder-row {
            display: flex;
            gap: 8px;
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .form-footer {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .form-footer .btn {
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid var(--accent);
            background: var(--bg-primary);
            border-radius: var(--btn-radius);
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }

        .btn.primary {
            background: var(--accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: flex;
            align-items: flex-end;
        }

        .modal {
            background: var(--bg-primary);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border-radius: var(--modal-radius) var(--modal-radius) 0 0;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            z-index: 10;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
        }

        .modal-close {
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            background: none;
            border: none;
            width: 32px;
            height: 32px;
        }

        .modal-body {
            padding: 16px;
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .modal-footer .btn {
            flex: 1;
        }

        .detail-item {
            margin-bottom: 16px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            word-break: break-all;
        }

        .detail-value.code {
            font-family: monospace;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: var(--input-radius);
            font-size: 13px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .settings-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: var(--btn-radius);
            font-size: 14px;
            z-index: 300;
        }

        .overview-card {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .overview-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .overview-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .overview-value.accent {
            color: var(--accent);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .overview-item {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .overview-item-title {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .overview-item-value {
            font-size: 20px;
            font-weight: 600;
        }

        .section-card {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-card-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .platform-card {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .platform-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .platform-icon svg {
            width: 24px;
            height: 24px;
        }

        .platform-info {
            flex: 1;
        }

        .platform-info-name {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .platform-info-balance {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .platform-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.healthy {
            background: var(--success);
        }

        .status-indicator.warning {
            background: var(--warning);
        }

        .status-indicator.unknown {
            background: var(--text-tertiary);
        }

        .usage-percent-bar {
            width: 60px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .usage-percent-fill {
            height: 100%;
            border-radius: 2px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-top: 8px;
        }

        .timelimit-card {
            background: var(--bg-primary);
            border-radius: var(--card-radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--accent);
        }

        .timelimit-card.expiring-soon {
            border-left-color: var(--warning);
            background: rgba(255, 59, 48, 0.05);
        }

        .timelimit-card.expired {
            border-left-color: var(--text-tertiary);
            opacity: 0.6;
        }

        .timelimit-info {
            flex: 1;
        }

        .timelimit-name {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .timelimit-platform {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .timelimit-amount {
            text-align: right;
        }

        .timelimit-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }

        .timelimit-expire {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .timelimit-expire.warning {
            color: var(--warning);
        }

        /* æ–°å¢æ ·å¼ï¼šå¹³å°å¤§å¡ç‰‡ä¸æŠ˜å åŠ¨ç”» */
        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .platform-header:active {
            background: var(--bg-secondary);
            transform: scale(0.98);
        }

        .platform-info-main {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .platform-icon-large {
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
        }

        .platform-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .platform-name-large {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .platform-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .platform-arrow {
            font-size: 20px;
            color: var(--text-tertiary);
            transition: transform 0.3s ease;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .platform-arrow.expanded {
            transform: rotate(90deg);
        }

        .key-list-wrapper {
            margin-bottom: 16px;
            padding: 0 4px;
        }

        /* è°ƒæ•´ key-item æ ·å¼ä»¥é€‚åº”æŠ˜å åˆ—è¡¨ */
        .key-list-wrapper .key-item {
            margin-bottom: 8px;
            border-left: 3px solid transparent;
        }

        .key-list-wrapper .key-item:hover {
            border-color: var(--accent);
        }
    </style>
</head>

<body>
    <div id="app">
        <div v-if="currentPage === 'home'" class="page">
            <div class="page-header" style="margin-bottom: 24px;">
                <!-- æ”¹äº†APIç®¡ç†å™¨çš„æ ·å¼ -->
                <h1 class="page-title"
                    style="color: var(--accent); font-weight: 800; font-size: 24px; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff, 1px -1px #fff, -1px 1px #fff, 0 4px 12px rgba(0,0,0,0.15);">
                     API ç®¡ç†å™¨
                </h1>
                <!-- åˆ°è¿™ -->
                <div class="header-actions">
                    <button class="header-btn circular" @click="refreshAllBalances" title="åˆ·æ–°é¤˜é¡">
                        <span class="svg-icon" v-html="icons.refresh"></span>
                    </button>
                    <button class="header-btn circular" @click="currentPage = 'add'" title="æ·»åŠ  API">
                        <span class="svg-icon" v-html="icons.add"></span>
                    </button>
                </div>
            </div>


            <!-- æ”¹äº†é’±åŒ…çš„HTML -->
            <div class="overview-card" style="text-align: center; padding: 28px 16px 20px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">æ€»èµ„äº§ (çº¦åˆäººæ°‘å¸)</div>
                <div class="overview-value accent"
                    style="font-size: 38px; margin-bottom: 24px; text-shadow: 0 2px 10px rgba(255,105,180,0.1);">
                    <span style="font-size: 20px; margin-right: 2px;">Â¥</span>{{ assetsBreakdown.total }}
                </div>

                <div
                    style="display: flex; justify-content: center; align-items: center; padding-top: 16px; border-top: 1px dashed rgba(255,105,180,0.2);">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">CNY ä½™é¢</div>
                        <div style="font-size: 16px; font-weight: 600;">Â¥{{ assetsBreakdown.cny }}</div>
                    </div>
                    <div style="width: 1px; height: 24px; background: var(--accent); opacity: 0.2;"></div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">USD ä½™é¢</div>
                        <div style="font-size: 16px; font-weight: 600;">${{ assetsBreakdown.usd }}</div>
                    </div>
                </div>
            </div>
            <!-- åˆ°è¿™ -->


            <!-- æ”¹äº†ä¸»é¡µé¢çš„å¡ç‰‡æ ·å¼ï¼Œåˆ é™¤äº†å¹³å°æ€»æ•° -->
            <div class="overview-grid"
                style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 12px; margin-bottom: 16px;">

                <div class="overview-item"
                    style="grid-row: span 2; display: flex; flex-direction: column; justify-content: space-between; padding: 20px 16px; background: rgba(255, 255, 255, 0.8) !important;">
                    <div>
                        <div style="font-size: 13px; color: var(--text-tertiary); margin-bottom: 8px;">æœ¬æœˆæ¶ˆè´¹ (çº¦åˆ)</div>
                        <div class="overview-value accent" style="font-size: 32px; font-weight: 700;">
                            <span style="font-size: 16px; margin-right: 2px;">Â¥</span>{{ spendingBreakdown.total }}
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1.5px dashed rgba(255,105,180,0.2);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 6px; height: 6px; border-radius: 50%; background: #FF69B4;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">CNY è´¦å•</span>
                            </div>
                            <span style="font-size: 15px; font-weight: 600;">Â¥{{ spendingBreakdown.cny }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 6px; height: 6px; border-radius: 50%; background: #007AFF;"></div>
                                <span style="font-size: 13px; color: var(--text-secondary);">USD è´¦å•</span>
                            </div>
                            <span style="font-size: 15px; font-weight: 600;">${{ spendingBreakdown.usd }}</span>
                        </div>
                    </div>
                </div>

                <div class="overview-item"
                    style="display: flex; flex-direction: column; justify-content: center; padding: 16px;">
                    <div class="overview-item-title">Key æ€»æ•°</div>
                    <div class="overview-item-value" style="font-size: 24px;">{{ apiKeys.length }}</div>
                </div>

                <div class="overview-item"
                    style="display: flex; flex-direction: column; justify-content: center; padding: 16px;">
                    <div class="overview-item-title">å³å°†åˆ°æœŸ</div>
                    <div class="overview-item-value" style="font-size: 24px;"
                        :style="{ color: expiringCount > 0 ? 'var(--warning)' : 'inherit' }">{{ expiringCount }}</div>
                </div>

            </div>
            <!-- æ”¹äº†ä¸»é¡µé¢çš„å¡ç‰‡æ ·å¼ï¼Œåˆ é™¤äº†å¹³å°æ€»æ•° åˆ°è¿™ -->


            <!-- æ”¹äº†å¹³å°èµ„äº§æ˜ç»†çš„æ ·å¼ï¼Œä¿®æ”¹äº†å›¾ç‰‡æŠ“å–é€»è¾‘ -->
            <div class="section-card"
                style="background: rgba(255, 255, 255, 0.7) !important; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
                <div class="section-card-title" style="color: var(--accent); font-weight: 700; font-size: 15px; text-shadow: 1.5px 0 #fff, -1.5px 0 #fff, 0 1.5px #fff, 0 -1.5px #fff, 0 2px 8px rgba(0,0,0,0.1);">
                    <span style="font-size: 18px; margin-right: 4px;">ğŸ‘›</span> å¹³å°èµ„äº§æ˜ç»†
                </div>

                <div v-if="platformStats.length === 0" class="empty-state" style="padding: 20px;">
                    <div style="color: var(--text-tertiary);">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ·»åŠ  API Key</div>
                </div>

                <div v-for="platform in platformStats" :key="platform.id" class="platform-card"
                    style="background: rgba(255, 255, 255, 0.85); border: 1px solid #ffffff; border-radius: 16px; box-shadow: 0 4px 12px rgba(255,105,180,0.06); margin-bottom: 12px; transition: transform 0.2s;">

                    <div class="platform-icon"
                        style="background: #ffffff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 4px;">
                        <img :src="'https://www.google.com/s2/favicons?sz=64&domain_url=' + (platforms.find(p => p.id === platform.id)?.signInUrl || 'google.com')"
                            style="width: 24px; height: 24px; border-radius: 6px;"
                            @error="$event.target.style.display='none'">
                    </div>

                    <div class="platform-info">
                        <div class="platform-info-name" style="font-weight: 600; font-size: 15px;">{{ platform.name }}
                        </div>
                        <div class="platform-info-balance" style="font-size: 12px; color: var(--text-secondary);">
                            ä½™é¢: <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">{{
                                formatBalance(platform.totalRemaining, platform.currency, platform.balanceType)
                                }}</span>
                        </div>
                    </div>

                    <div class="platform-status">
                        <div class="usage-percent-bar"
                            style="height: 6px; background: rgba(0,0,0,0.04); border-radius: 4px;">
                            <div class="usage-percent-fill" :style="{ 
                                     width: Math.min(100, platform.usagePercent || 0) + '%',
                                     background: (platform.usagePercent || 0) > 80 ? 'var(--warning)' : 'var(--accent)',
                                     borderRadius: '4px'
                                 }"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- æ”¹äº†å¹³å°èµ„äº§æ˜ç»†çš„æ ·å¼ï¼Œä¿®æ”¹äº†å›¾ç‰‡æŠ“å–é€»è¾‘ åˆ°è¿™ -->

            <div v-if="timeLimitKeys.length > 0" class="section-card">
                <div class="section-card-title">
                    <span class="svg-icon small" v-html="icons.refresh"></span>
                    é™æ—¶é¢åº¦æé†’
                </div>
                <div v-for="key in timeLimitKeys" :key="key.id" class="timelimit-card"
                    :class="{ 'expiring-soon': isExpiringSoon(key), 'expired': isExpired(key) }"
                    style="box-shadow: none; background: var(--bg-secondary);">
                    <div class="timelimit-info">
                        <div class="timelimit-name">{{ key.name || 'æœªå‘½å' }}</div>
                        <div class="timelimit-platform">{{ getPlatformName(key.platform) }}</div>
                    </div>
                    <div class="timelimit-amount">
                        <div class="timelimit-value">{{ formatCurrency(key.timeLimit.amount, getPlatformCurrency(key))
                            }}</div>
                        <div class="timelimit-expire" :class="{ warning: isExpiringSoon(key) }">
                            {{ isExpired(key) ? 'å·²è¿‡æœŸ' : formatTimeLeft(key.timeLimit.expireAt) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentPage === 'add'" class="page">
            <div class="page-header">
                <h1 class="page-title">{{ form.editingId ? 'ç¼–è¾‘ API Key' : 'æ·»åŠ  API Key' }}</h1>
            </div>

            <div class="form-group">
                <label class="form-label">å¹³å°</label>
                <select v-model="form.platform" class="form-select" @change="onPlatformChange">
                    <option value="">é€‰æ‹©å¹³å°</option>
                    <optgroup label="é¢„è®¾å¹³å°">
                        <option v-for="p in presetPlatforms" :key="p.id" :value="p.id">{{ p.name }}</option>
                    </optgroup>
                    <optgroup v-if="savedCustomPlatforms.length > 0" label="å·²ä¿å­˜çš„è‡ªå®šä¹‰å¹³å°">
                        <option v-for="p in savedCustomPlatforms" :key="p.id" :value="p.id">{{ p.name }}</option>
                    </optgroup>
                    <option value="custom">+ æ–°å»ºè‡ªå®šä¹‰å¹³å°</option>
                </select>
            </div>

            <div v-if="form.platform === 'custom'" class="form-group">
                <label class="form-label">å¹³å°åç§°</label>
                <input type="text" v-model="form.customPlatformName" class="form-input" placeholder="è¾“å…¥å¹³å°åç§°">
            </div>

            <div v-if="form.platform === 'custom'" class="form-group">
                <label class="form-label">ä½™é¢æŸ¥è¯¢APIï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" v-model="form.customBalanceApi" class="form-input"
                    placeholder="https://api.example.com/api/user/self">
                <div class="form-hint">å¡«å†™ä½™é¢æŸ¥è¯¢æ¥å£åœ°å€ï¼Œå¦‚ï¼šhttps://xxx.com/api/user/self</div>
            </div>

            <div v-if="form.platform === 'custom'" class="form-group">
                <label class="form-label">ä½™é¢å­—æ®µè·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" v-model="form.customBalancePath" class="form-input" placeholder="data.balance">
                <div class="form-hint">JSONè·¯å¾„å¦‚ data.balanceï¼Œæˆ–å…¬å¼å¦‚ value/100</div>
            </div>

            <div v-if="form.platform === 'custom'" class="form-group">
                <label class="form-label">è¯·æ±‚æ–¹æ³•ï¼ˆå¯é€‰ï¼‰</label>
                <select v-model="form.customBalanceMethod" class="form-select">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="text" v-model="form.key" class="form-input" placeholder="sk-...">
            </div>

            <div class="form-group">
                <label class="form-label">åç§°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" v-model="form.name" class="form-input" placeholder="å¦‚ï¼šä¸»è´¦å·">
            </div>

            <div class="form-group">
                <label class="form-label">Base URLï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" v-model="form.baseUrl" class="form-input" placeholder="https://api.example.com/v1">
            </div>

            <div class="form-group">
                <label class="form-label">é™é¢æé†’</label>
                <div class="limit-reminder-row">
                    <input type="number" v-model="form.limitReminder" class="form-input" placeholder="0.00" step="0.01"
                        style="flex:1">
                    <select v-model="form.limitReminderType" class="form-select" style="width:100px">
                        <option value="amount">é‡‘é¢</option>
                        <option value="percent">ç™¾åˆ†æ¯”</option>
                    </select>
                </div>
                <div class="form-hint">å½“ä½™é¢ä½äºæ­¤å€¼æ—¶æé†’ï¼ˆé‡‘é¢ï¼šå…·ä½“æ•°å€¼ï¼Œç™¾åˆ†æ¯”ï¼šå¦‚20è¡¨ç¤ºä½™é¢ä½äº20%æ—¶æé†’ï¼‰</div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" v-model="form.autoQuery">
                    <span>è‡ªåŠ¨æŸ¥è¯¢ä½™é¢</span>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label">æ ‡ç­¾</label>
                <div class="tag-input">
                    <span v-for="(tag, i) in form.tags" :key="i" class="tag-item">
                        {{ tag }}
                        <span class="tag-remove" @click="removeTag(i)">Ã—</span>
                    </span>
                    <input type="text" v-model="tagInput" @keydown.space.prevent="addTag" placeholder="è¾“å…¥æ ‡ç­¾æŒ‰ç©ºæ ¼">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">å¤‡æ³¨</label>
                <textarea v-model="form.note" class="form-textarea" placeholder="æ·»åŠ å¤‡æ³¨è¯´æ˜..."></textarea>
            </div>

            <div class="collapse-section" @click="showAdvanced = !showAdvanced">
                <span class="collapse-title">é«˜çº§é€‰é¡¹</span>
                <span class="collapse-arrow" :class="{ expanded: showAdvanced }">â€º</span>
            </div>

            <div v-if="showAdvanced" class="advanced-options">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æ€»é¢åº¦</label>
                        <input type="number" v-model="form.balanceTotal" class="form-input" placeholder="0.00"
                            step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å·²ç”¨é¢åº¦</label>
                        <input type="number" v-model="form.balanceUsed" class="form-input" placeholder="0.00"
                            step="0.01">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¸ç§</label>
                        <select v-model="form.currency" class="form-select">
                            <option value="CNY">CNY (Â¥)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (â‚¬)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç­¾åˆ°é“¾æ¥ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" v-model="form.signInUrl" class="form-input" placeholder="https://...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é™æ—¶é¢åº¦</label>
                        <input type="number" v-model="form.timeLimitAmount" class="form-input" placeholder="0.00"
                            step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆ°æœŸæ—¶é—´</label>
                        <input type="datetime-local" v-model="form.timeLimitExpire" class="form-input">
                    </div>
                </div>
            </div>

            <div class="form-footer">
                <button class="btn" @click="cancelAdd">å–æ¶ˆ</button>
                <button class="btn primary" @click="saveKey">ä¿å­˜</button>
            </div>
        </div>

        <div v-if="currentPage === 'manage'" class="tab-content animate-fade-in" style="padding: 16px; margin-bottom: 80px; max-width: 800px; margin-left: auto; margin-right: auto;">
                <div class="section-card" style="background: rgba(255, 255, 255, 0.7) !important; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding: 20px; border-radius: 24px; box-shadow: 0 8px 32px rgba(255,105,180,0.1);">
                    
                    <div class="page-header" style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; background: transparent;">
                        <h1 class="page-title" style="color: var(--accent); font-weight: 800; font-size: 24px; text-shadow: 2.5px 0 #fff, -2.5px 0 #fff, 0 2.5px #fff, 0 -2.5px #fff, 0 4px 10px rgba(0,0,0,0.1);">
                            ç®¡ç† API Key
                        </h1>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="header-btn circular" @click="isEditMode = !isEditMode" style="width: auto; padding: 0 12px; border-radius: 12px; font-size: 13px; font-weight: 600; background: white !important; color: var(--accent) !important; border: 1.5px solid rgba(255,105,180,0.1);">
                                {{ isEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘' }}
                            </button>
                            <button class="header-btn circular" @click="currentPage = 'add'" style="background: white !important; color: var(--accent) !important; border: 1.5px solid rgba(255,105,180,0.1);">
                                <span class="svg-icon small" v-html="icons.add"></span>
                            </button>
                        </div>
                    </div>

                    <div class="filter-bar" style="background: rgba(255, 255, 255, 0.4); padding: 4px; border-radius: 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.5); display: flex; gap: 4px;">
                        <button class="filter-btn" :class="{ active: !filterPlatform }" @click="filterPlatform = ''" 
                                style="flex: 1; border-radius: 10px; padding: 8px; font-size: 13px; border: none; transition: all 0.3s; background: transparent;">
                            å…¨éƒ¨
                        </button>
                        <button v-for="p in platformsWithKeys" :key="p.id" class="filter-btn"
                            :class="{ active: filterPlatform === p.id }" @click="filterPlatform = p.id"
                            style="flex: 1; border-radius: 10px; padding: 8px; font-size: 13px; border: none; transition: all 0.3s; background: transparent;">
                            {{ p.name }}
                        </button>
                    </div>
                </div> 

            <div v-if="groupedKeys.length === 0" class="empty-state">
                <div class="empty-icon">
                    <span class="svg-icon large" v-html="icons.list"></span>
                </div>
                <div>æš‚æ—  API Key</div>
            </div>

            <div v-for="group in groupedKeys" :key="group.platform" class="platform-section">
                <div class="platform-header" @click.stop="togglePlatform(group.platform)">
                    <div class="platform-info-main">
                        <div class="platform-details">
                            <span class="platform-name-large">{{ group.name }}</span>
                            <span class="platform-meta">
                                {{ group.keys.length }} ä¸ª Key Â· ä½™é¢ {{ formatCurrency(getGroupBalance(group.platform),
                                getGroupCurrency(group.platform)) }}
                                <span v-if="getPlatformInitialBalance(group.platform) > 0">
                                    Â· ç”¨é‡ {{ formatCurrency(getPlatformUsage(group.platform),
                                    getGroupCurrency(group.platform)) }}
                                </span>
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="header-btn" style="width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255,105,180,0.1); color: var(--accent); display: flex; align-items: center; justify-content: center;"
                            @click.stop="openPlatformSettings(group.platform)">
                            <span class="svg-icon small" v-html="icons.settings"></span>
                        </button>
                        <div class="platform-arrow" :class="{ expanded: expandedPlatforms.includes(group.platform) }">â€º
                        </div>
                    </div>
                </div>
                <div class="key-list-wrapper" v-show="expandedPlatforms.includes(group.platform)">
                    <div class="key-list">
                        <div v-for="key in group.keys" :key="key.id" class="key-item"
                            :class="{ warning: isExpiringSoon(key) }">
                            <div class="key-header">
                                <span class="key-title">{{ key.name || 'æœªå‘½å' }}</span>
                                <span v-if="isEditMode" class="key-menu" @click="deleteKey(key)">Ã—</span>
                            </div>
                            <div class="key-info">
                                <div class="key-row">
                                    <span class="key-masked">{{ key.showKey ? decryptKey(key.key) :
                                        maskKey(decryptKey(key.key)) }}</span>
                                    <span @click="toggleKeyVisibility(key)" style="cursor: pointer;">
                                        {{ key.showKey ? 'éšè—' : 'æ˜¾ç¤º' }}
                                    </span>
                                </div>
                                <div class="key-row">
                                    <span>å¹³å°ä½™é¢: {{ formatCurrency(getPlatformBalance(key), getPlatformCurrency(key))
                                        }}</span>
                                    <div class="balance-bar">
                                        <div class="balance-fill" :class="{ warning: getUsagePercent(key) > 80 }"
                                            :style="{ width: getUsagePercent(key) + '%' }"></div>
                                    </div>
                                    <span>{{ getUsagePercent(key).toFixed(0) }}%</span>
                                </div>
                                <!-- æ¶ˆè´¹ä¿¡æ¯å·²éšè— -->
                                <div class="key-actions">
                                    <button class="key-btn" @click="copyKey(key)">å¤åˆ¶key</button>
                                    <button class="key-btn" @click="copyUrl(key)">å¤åˆ¶url</button>
                                    <button v-if="key.signInUrl" class="key-btn" @click="openSignIn(key)">ç­¾åˆ°</button>
                                    <button class="key-btn primary" @click="openDetailModal(key)">è¯¦æƒ…</button>
                                </div>

                                <div class="key-note-area">
                                    <div v-if="editingNoteId !== key.id" class="note-display"
                                        @click="startEditNote(key)">
                                        {{ key.note || 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨...' }}
                                    </div>
                                    <textarea v-else class="note-input" v-model="editingNoteText" @blur="saveNote(key)"
                                        @keydown.enter.prevent="saveNote(key)" placeholder="è¾“å…¥å¤‡æ³¨..."
                                        autofocus></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!-- ä¸´æ—¶ -->
<div v-if="currentPage === 'stats'" class="page">
            <div class="page-header" style="margin-bottom: 20px;">
                <h1 class="page-title" style="color: var(--accent); font-weight: 800; font-size: 24px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff;">
                    æ•°æ®ç»Ÿè®¡
                </h1>
            </div>

            <div style="display: flex; background: rgba(255,255,255,0.5); border-radius: 16px; padding: 4px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
                <button @click="statsTab = 'chart'" 
                        :style="{ flex: 1, padding: '10px 0', borderRadius: '12px', border: 'none', fontSize: '14px', fontFamily: 'inherit', fontWeight: 'bold', transition: 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)', background: statsTab === 'chart' ? 'white' : 'transparent', color: statsTab === 'chart' ? 'var(--accent)' : 'var(--text-secondary)', boxShadow: statsTab === 'chart' ? '0 2px 10px rgba(255,105,180,0.15)' : 'none', cursor: 'pointer' }">
                    ğŸ“Š å›¾è¡¨æ’è¡Œ
                </button>
                <button @click="statsTab = 'calendar'" 
                        :style="{ flex: 1, padding: '10px 0', borderRadius: '12px', border: 'none', fontSize: '14px', fontFamily: 'inherit', fontWeight: 'bold', transition: 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)', background: statsTab === 'calendar' ? 'white' : 'transparent', color: statsTab === 'calendar' ? 'var(--accent)' : 'var(--text-secondary)', boxShadow: statsTab === 'calendar' ? '0 2px 10px rgba(255,105,180,0.15)' : 'none', cursor: 'pointer' }">
                    ğŸ“… æ¶ˆè´¹æ—¥å†
                </button>
            </div>

            <div v-if="statsTab === 'chart'">
                <div class="chart-tabs">
                    <button class="chart-tab" :class="{ active: chartPeriod === '7d' }" @click="chartPeriod = '7d'">è¿‘7å¤©</button>
                    <button class="chart-tab" :class="{ active: chartPeriod === '30d' }" @click="chartPeriod = '30d'">è¿‘30å¤©</button>
                    <button class="chart-tab" :class="{ active: chartPeriod === '90d' }" @click="chartPeriod = '90d'">è¿‘90å¤©</button>
                </div>

                <div class="chart-container" ref="chartContainer" style="background: rgba(255, 255, 255, 0.7) !important; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);"></div>

                <div class="stats-panel" style="background: rgba(255, 255, 255, 0.7) !important; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
                    <div class="stats-header">
                        <span class="stats-title" style="color: var(--accent); font-weight: 700;">å¹³å°ç”¨é‡æ’è¡Œ</span>
                    </div>
                    <div class="stats-list">
                        <div v-for="(item, index) in usageRanking" :key="item.platform" class="stats-row">
                            <div class="stats-row-left">
                                <span style="width: 20px; font-size: 12px; color: var(--text-tertiary);">{{ index + 1 }}</span>
                                <img :src="'https://www.google.com/s2/favicons?sz=64&domain_url=' + (item.signInUrl || 'google.com')"
                                     style="width: 20px; height: 20px; border-radius: 4px; margin-right: 8px;"
                                     @error="$event.target.style.display='none'">
                                <span class="stats-name">{{ item.name }}</span>
                            </div>
                            <span class="stats-amount" style="font-weight: 600;">{{ formatCurrency(item.usage, item.currency) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="statsTab === 'calendar'">
                <div class="stats-panel" style="background: rgba(255, 255, 255, 0.7) !important; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
                    <div class="stats-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed rgba(255,105,180,0.2); padding: 16px;">
                        <button @click="prevMonth" style="background: white; border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--accent); cursor: pointer; box-shadow: 0 2px 8px rgba(255,105,180,0.15); font-size: 14px; display: flex; align-items: center; justify-content: center;">â—€</button>
                        <span class="stats-title" style="color: var(--accent); font-weight: 800; font-size: 16px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;">
                            {{ currentMonth.getFullYear() }}å¹´{{ currentMonth.getMonth() + 1 }}æœˆ
                        </span>
                        <button @click="nextMonth" style="background: white; border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--accent); cursor: pointer; box-shadow: 0 2px 8px rgba(255,105,180,0.15); font-size: 14px; display: flex; align-items: center; justify-content: center;">â–¶</button>
                    </div>
                    
                    <div style="padding: 16px;">
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 13px; color: var(--text-tertiary); margin-bottom: 12px; font-weight: 700;">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;">
                            <div v-for="(day, index) in calendarData" :key="index" 
                                 style="aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.3s;"
                                 :style="{
                                     background: day.spent > 0 ? 'rgba(255, 255, 255, 0.9)' : 'rgba(255, 255, 255, 0.3)',
                                     boxShadow: day.spent > 0 ? '0 4px 10px rgba(255, 105, 180, 0.15)' : 'none',
                                     opacity: day.isCurrentMonth ? 1 : 0.3
                                 }">
                                <span style="font-size: 14px; font-weight: 700;" :style="{ color: day.spent > 0 ? 'var(--text-primary)' : 'var(--text-secondary)' }">{{ day.day }}</span>
                                <span v-if="day.spent > 0" style="font-size: 9px; color: var(--accent); font-weight: 800; margin-top: 2px;">
                                    Â¥{{ day.spent < 1 ? day.spent.toFixed(2) : day.spent.toFixed(1) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
<!-- åˆ æ”¹éƒ¨åˆ†åŠ æ—¥å† -->
        <div v-if="currentPage === 'settings'" class="page">
            <h1 class="page-title">è®¾ç½®</h1>
            <!-- 1.ä¿®æ”¹éƒ¨åˆ†ï¼Œå¢åŠ é¢œè‰²é€‰é¡¹ 2ã€å¢åŠ äº†å¿ƒå½¢è¦†ç›–å›¾æ ‡ -->
            <div class="settings-section" style="margin-top: 20px;">
                <div class="settings-title">å¤–è§‚</div>
                <div class="settings-item">
                    <span class="settings-item-text">ä¸»é¢˜é¢œè‰²</span>
                    <!-- ä¿®æ”¹äº†å¿ƒå½¢è¦†ç›–èŒƒå›´å’Œå¤§å° -->
                    <div style="position: relative; width: 36px; height: 36px;">
    <input type="color" v-model="themeColor" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.01; cursor: pointer; z-index: 10; border: none; appearance: none; -webkit-appearance: none;">
    <svg viewBox="0 0 24 24" :fill="themeColor" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 5; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
    </svg>
</div>
<!-- ä¿®æ”¹äº†å¿ƒå½¢è¦†ç›–èŒƒå›´å’Œå¤§å° åˆ°è¿™-->
                </div>
            </div>
            <!-- åˆ°è¿™ -->
            <!-- è‡ªå®šä¹‰èƒŒæ™¯å›¾åŠŸèƒ½ -->
            <div class="settings-item">
                <span class="settings-item-text">è‡ªå®šä¹‰èƒŒæ™¯å›¾</span>
                <div style="display: flex; gap: 8px;">
                    <button class="filter-btn" v-if="customBg" @click="clearBg"
                        style="padding: 4px 10px; font-size: 12px;">æ¸…é™¤</button>
                    <label class="filter-btn"
                        style="padding: 4px 10px; font-size: 12px; cursor: pointer; margin: 0; background: var(--accent); color: white; border: none; border-radius: 8px;">
                        ä¸Šä¼ å›¾ç‰‡
                        <input type="file" @change="handleBgUpload" accept="image/*" style="display: none;">
                    </label>
                </div>
            </div>
            <!-- åˆ°è¿™ -->


            <div class="settings-section">
                <div class="settings-title">æ•°æ®ç®¡ç†</div>
                <div class="settings-item" @click="exportData">
                    <span class="settings-item-text">å¯¼å‡ºæ•°æ®</span>
                    <span>â€º</span>
                </div>
                <div class="settings-item" @click="triggerImport">
                    <span class="settings-item-text">å¯¼å…¥æ•°æ®</span>
                    <span>â€º</span>
                </div>
                <div class="settings-item" style="color: var(--warning);" @click="clearAllData">
                    <span class="settings-item-text">æ¸…ç©ºæ‰€æœ‰æ•°æ®</span>
                    <span>â€º</span>
                </div>
                <input type="file" ref="importFile" style="display: none;" @change="importData" accept=".json">
            </div>

            <div class="settings-section">
                <div class="settings-title">ç»Ÿè®¡ä¿¡æ¯</div>
                <div class="settings-item">
                    <span class="settings-item-text">å¹³å°æ•°é‡</span>
                    <span>{{ platformStats.length }}</span>
                </div>
                <div class="settings-item">
                    <span class="settings-item-text">API Key æ•°é‡</span>
                    <span>{{ apiKeys.length }}</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">å…³äº</div>
                <div class="settings-item">
                    <span class="settings-item-text">ç‰ˆæœ¬</span>
                    <span>v1.1.0</span>
                </div>
                <div class="settings-item">
                    <span class="settings-item-text">æ•°æ®å­˜å‚¨</span>
                    <span>æœ¬åœ° LocalStorage</span>
                </div>
            </div>
        </div>

        <div v-if="showDetailModal" class="modal-overlay" @click.self="closeDetailModal">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">å¯†é’¥è¯¦æƒ…</span>
                    <button class="modal-close" @click="closeDetailModal">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="detail-item">
                        <div class="detail-label">å¹³å°</div>
                        <div class="detail-value">{{ getPlatformName(detailKey.platform) }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">åç§°</div>
                        <div class="detail-value">{{ detailKey.name || '-' }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">API Key</div>
                        <div class="detail-value code">{{ decryptKey(detailKey.key) }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Base URL</div>
                        <div class="detail-value">{{ detailKey.baseUrl || '-' }}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å¹³å°ä½™é¢</div>
                        <div class="detail-value">
                            {{ formatCurrency(getPlatformBalance(detailKey), getPlatformCurrency(detailKey)) }}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ¬Keyæ¶ˆè´¹</div>
                        <div class="detail-value">
                            {{ formatCurrency(detailKey.totalUsed || 0, getPlatformCurrency(detailKey)) }}
                            (å å¹³å°æ€»é¢ {{ getUsagePercent(detailKey).toFixed(1) }}%)
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æœ€åæŸ¥è¯¢</div>
                        <div class="detail-value">{{ detailKey.lastQuery ? formatDate(detailKey.lastQuery) : 'ä»æœª' }}
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">æ ‡ç­¾</div>
                        <div class="detail-value">
                            <span v-if="detailKey.tags?.length" v-for="tag in detailKey.tags" :key="tag" class="tag">{{
                                tag }}</span>
                            <span v-else>-</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">å¤‡æ³¨</div>
                        <div class="detail-value">{{ detailKey.note || '-' }}</div>
                    </div>
                    <div v-if="getPlatformBalanceHistory(detailKey).length" class="detail-item">
                        <div class="detail-label">å¹³å°ä½¿ç”¨è®°å½•</div>
                        <div class="history-list">
                            <div v-for="(item, i) in getPlatformBalanceHistory(detailKey).slice(-10).reverse()" :key="i"
                                class="history-item">
                                <span>{{ formatDateShort(item.date) }}</span>
                                <span>æ¶ˆè´¹ {{ formatCurrency(item.used, getPlatformCurrency(detailKey)) }}</span>
                                <span>å¹³å°ä½™é¢ {{ formatCurrency(item.balance, getPlatformCurrency(detailKey)) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" @click="editKey(detailKey)">ç¼–è¾‘</button>
                    <button class="btn primary" @click="queryBalance(detailKey)">æŸ¥è¯¢ä½™é¢</button>
                </div>
            </div>
        </div>

        <div v-if="showPlatformModal" class="modal-overlay" @click.self="closePlatformModal">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title">å¹³å°è¯¦æƒ…</span>
                    <button class="modal-close" @click="closePlatformModal">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">å¹³å°åç§°</label>
                        <input type="text" v-model="currentPlatform.name" class="form-input" placeholder="è¾“å…¥å¹³å°åç§°">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åˆå§‹é‡‘é¢</label>
                        <input type="number" v-model="currentPlatform.initialBalance" class="form-input"
                            placeholder="0.00" step="0.01">
                        <div class="form-hint">è®¾ç½®æ­¤é¡¹åï¼Œå°†è‡ªåŠ¨è®¡ç®—ï¼šç”¨é‡ = åˆå§‹é‡‘é¢ - å½“å‰ä½™é¢</div>
                    </div>
                    <div class="detail-item" v-if="currentPlatform.balance">
                        <div class="detail-label">å½“å‰ä½™é¢</div>
                        <div class="detail-value">{{ formatCurrency(currentPlatform.balance.remaining,
                            currentPlatform.balance.currency || 'CNY') }}</div>
                    </div>
                    <div class="detail-item" v-if="currentPlatform.initialBalance > 0 && currentPlatform.balance">
                        <div class="detail-label">è®¡ç®—ç”¨é‡</div>
                        <div class="detail-value accent" style="font-weight: 600;">
                            {{ formatCurrency(Math.max(0, currentPlatform.initialBalance -
                            currentPlatform.balance.remaining), currentPlatform.balance.currency || 'CNY') }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç»Ÿè®¡è®¾ç½®</label>
                        <label class="checkbox-label">
                            <input type="checkbox" v-model="currentPlatform.unmetered">
                            ä¸è®¡å…¥ç»Ÿè®¡
                        </label>
                        <div class="form-hint">å¯ç”¨åï¼Œè¯¥å¹³å°ä¸ä¼šå‡ºç°åœ¨ç”¨é‡å›¾è¡¨å’Œæ’è¡Œä¸­</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤‡æ³¨</label>
                        <textarea v-model="currentPlatform.note" class="form-textarea" placeholder="å¹³å°å¤‡æ³¨..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" @click="closePlatformModal">å–æ¶ˆ</button>
                    <button v-if="currentPlatform.isCustom" class="btn"
                        style="border-color: var(--warning); color: var(--warning);"
                        @click="deleteCurrentPlatform">åˆ é™¤å¹³å°</button>
                    <button class="btn primary" @click="savePlatformSettings">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item" :class="{ active: currentPage === 'home' }" @click="currentPage = 'home'">
                <div class="nav-icon">
                    <span class="svg-icon" v-html="icons.home"></span>
                </div>
                <span class="nav-label">é¦–é¡µ</span>
            </div>
            <div class="nav-item" :class="{ active: currentPage === 'manage' }" @click="currentPage = 'manage'">
                <div class="nav-icon">
                    <span class="svg-icon" v-html="icons.list"></span>
                </div>
                <span class="nav-label">ç®¡ç†</span>
            </div>
            <div class="nav-item" :class="{ active: currentPage === 'stats' }" @click="currentPage = 'stats'">
                <div class="nav-icon">
                    <span class="svg-icon" v-html="icons.chart"></span>
                </div>
                <span class="nav-label">ç»Ÿè®¡</span>
            </div>
            <div class="nav-item" :class="{ active: currentPage === 'settings' }" @click="currentPage = 'settings'">
                <div class="nav-icon">
                    <span class="svg-icon" v-html="icons.settings"></span>
                </div>
                <span class="nav-label">è®¾ç½®</span>
            </div>
        </nav>

        <div v-if="toast.show" class="toast">{{ toast.message }}</div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // æ›´æ”¹éƒ¨åˆ† ğŸŸ¢ èŠ¥æœ«æ³¥çš„ä¸»é¢˜è°ƒè‰²æ¿ï¼šé»˜è®¤çŒ›ç”·ç²‰ï¼
                const themeColor = ref(localStorage.getItem('themeColor') || '#ffdbdb');
                watch(themeColor, (newColor) => {
                    document.documentElement.style.setProperty('--accent', newColor);
                    localStorage.setItem('themeColor', newColor);
                }, { immediate: true });
                // åˆ°è¿™
                // å¢åŠ æ—¥å†åŠŸèƒ½
                // ğŸŸ¢ èŠ¥æœ«æ³¥ç‰¹åˆ¶ï¼šæ¶ˆè´¹æ—¥å†é€»è¾‘
                const currentMonth = ref(new Date());

                const prevMonth = () => {
                    currentMonth.value = new Date(currentMonth.value.getFullYear(), currentMonth.value.getMonth() - 1, 1);
                };
                const nextMonth = () => {
                    currentMonth.value = new Date(currentMonth.value.getFullYear(), currentMonth.value.getMonth() + 1, 1);
                };

                const calendarData = computed(() => {
                    const year = currentMonth.value.getFullYear();
                    const month = currentMonth.value.getMonth();
                    
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    
                    const days = [];
                    // å¡«å……ä¸Šä¸ªæœˆçš„ç©ºç™½
                    const startPadding = firstDay.getDay(); 
                    for (let i = startPadding - 1; i >= 0; i--) {
                        const d = new Date(year, month, -i);
                        days.push({ day: d.getDate(), date: d, isCurrentMonth: false, spent: 0 });
                    }
                    
                    // å¡«å……æœ¬æœˆ
                    for (let i = 1; i <= lastDay.getDate(); i++) {
                        const d = new Date(year, month, i);
                        days.push({ day: i, date: d, isCurrentMonth: true, spent: 0 });
                    }
                    
                    // å¡«å……ä¸‹ä¸ªæœˆçš„ç©ºç™½
                    const endPadding = 42 - days.length; // ä¿æŒ 6 è¡Œé«˜åº¦
                    for (let i = 1; i <= endPadding; i++) {
                        const d = new Date(year, month + 1, i);
                        days.push({ day: d.getDate(), date: d, isCurrentMonth: false, spent: 0 });
                    }
                    
                    // ç»Ÿè®¡æ¯å¤©çš„èŠ±è´¹ï¼Œç»Ÿä¸€æŠ˜ç®—æˆäººæ°‘å¸
                    const dailySpentMap = {};
                    platforms.value.forEach(platform => {
                        if (platform.unmetered || !platform.balance || !platform.balance.history) return;
                        
                        const currency = platform.currency || platform.balance.currency || 'CNY';
                        let rate = 1;
                        if (currency === 'USD') rate = exchangeRates.value.USD || 7.25;
                        else if (currency === 'EUR') rate = exchangeRates.value.EUR || 7.85;

                        platform.balance.history.forEach(record => {
                            if (!record.date) return;
                            const dateStr = record.date.split('T')[0];
                            if (!dailySpentMap[dateStr]) dailySpentMap[dateStr] = 0;
                            dailySpentMap[dateStr] += (record.used || 0) * rate;
                        });
                    });

                    // æ˜ å°„åˆ°å…·ä½“çš„æ ¼å­é‡Œ
                    days.forEach(dayObj => {
                        const localDateStr = new Date(dayObj.date.getTime() - (dayObj.date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                        if (dailySpentMap[localDateStr]) {
                            dayObj.spent = dailySpentMap[localDateStr];
                        }
                    });

                    return days;
                });
                // å¢åŠ æ—¥å†åŠŸèƒ½ï¼Œåˆ°è¿™
                // å¢åŠ èƒŒæ™¯ä¸Šä¼ åŠŸèƒ½
                // ğŸŸ¢ èŠ¥æœ«æ³¥çš„å£çº¸å¼•æ“
                const customBg = ref(localStorage.getItem('customBg') || '');
                watch(customBg, (newBg) => {
                    if (newBg) {
                        document.body.style.backgroundImage = `url(${newBg})`;
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed';
                    } else {
                        // å¦‚æœæ²¡æœ‰å£çº¸ï¼Œå°±ç”¨é»˜è®¤çš„æ£‰èŠ±ç³–æ¸å˜
                        document.body.style.backgroundImage = 'linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 50%, #E6E6FA 100%)';
                    }
                    localStorage.setItem('customBg', newBg || '');
                }, { immediate: true });

                function handleBgUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    // é˜²æ­¢å›¾ç‰‡å¤ªå¤§å¡æ­»æµè§ˆå™¨ï¼Œé™åˆ¶åœ¨ 3MB å†…
                    if (file.size > 3 * 1024 * 1024) {
                        showToast('å›¾ç‰‡å¤ªå¤§äº†ï¼è¯·é€‰æ‹© 3MB ä»¥ä¸‹çš„å›¾ç‰‡å“¦~');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        customBg.value = e.target.result;
                        showToast('å£çº¸æ¢å¥½å•¦ï¼');
                    };
                    reader.readAsDataURL(file);
                }

                function clearBg() {
                    customBg.value = '';
                    showToast('å·²æ¢å¤é»˜è®¤å£çº¸');
                }
                // å¢åŠ èƒŒæ™¯ä¸Šä¼ åŠŸèƒ½ åˆ°è¿™
                const exchangeRates = ref({ USD: 7.25, EUR: 7.85 });
                async function fetchExchangeRates() {
                    try {
                        const response = await fetch('https://open.er-api.com/v6/latest/USD');
                        const data = await response.json();
                        if (data && data.rates) {
                            exchangeRates.value.USD = data.rates.CNY;
                            exchangeRates.value.EUR = data.rates.CNY / data.rates.EUR;
                            console.log('æ±‡ç‡æ›´æ–°æˆåŠŸï¼š', exchangeRates.value);
                        }
                    } catch (e) {
                        console.error('æ±‡ç‡æ›´æ–°å¤±è´¥', e);
                    }
                }
                const expandedPlatforms = ref([]);
                const showPlatformModal = ref(false);
                const currentPlatform = ref({});

                const togglePlatform = (platformId) => {
                    const index = expandedPlatforms.value.indexOf(platformId);
                    if (index === -1) {
                        expandedPlatforms.value.push(platformId);
                    } else {
                        expandedPlatforms.value.splice(index, 1);
                    }
                };

                const icons = {
                    home: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
                    list: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
                    chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
                    // ğŸŸ¢ èŠ¥æœ«æ³¥ç‰¹ä¾›ï¼šæŠŠè®¾ç½®çš„â€œé»‘è‰²é½¿è½®èŠ±â€å˜æˆå°çˆ±å¿ƒ
                    // ğŸŸ¢ èŠ¥æœ«æ³¥ç‰¹ä¾›ï¼šå®Œç¾çš„å®å¿ƒå°çˆ±å¿ƒ
                    settings: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>',
                    add: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
                    // ğŸŸ¢ èŠ¥æœ«æ³¥ç‰¹ä¾›ï¼šæç®€çº¤ç»†ç‰ˆåŒç®­å¤´å¾ªç¯
                    refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>',
                    openai: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.872zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"/></svg>',
                    deepseek: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>',
                    zhipu: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
                    moonshot: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>',
                    siliconflow: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
                    aliyun: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>',
                    anthropic: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.703 3.938h4.813l5.875 12.562h-4.813L4.703 3.938zm9.594 0h4.813l-5.875 12.562H8.422l5.875-12.562z"/></svg>',
                    gemini: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg>',
                    azure: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M5.48 19.403l6.23-16.403h.59l6.23 16.403h-.59l-6.23-16.403h-.59l-6.23 16.403h.59zm1.18 0l5.05-13.293 5.05 13.293h-10.1z"/></svg>',
                    custom: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
                    // åœ¨ icons å¯¹è±¡æœ«å°¾æ·»åŠ ï¼ˆæ³¨æ„å‰é¢çš„é€—å·ï¼‰
                    openrouter: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/></svg>'
                };

                const defaultPlatforms = [
                    {
                        id: 'openai',
                        name: 'OpenAI',
                        baseUrl: 'https://api.openai.com/v1',
                        signInUrl: 'https://platform.openai.com/settings/usage',
                        balanceApi: 'https://api.openai.com/v1/dashboard/billing/credit_grants',
                        balancePath: 'total_available',
                        balanceMethod: 'GET',
                        currency: 'USD',
                        balanceType: 'currency',
                        icon: icons.openai,
                        note: ''
                    },
                    {
                        id: 'azure',
                        name: 'Azure OpenAI',
                        signInUrl: 'https://portal.azure.com/',
                        currency: 'USD',
                        balanceType: 'currency',
                        icon: icons.azure,
                        note: ''
                    },
                    {
                        id: 'anthropic',
                        name: 'Anthropic',
                        baseUrl: 'https://api.anthropic.com',
                        signInUrl: 'https://console.anthropic.com/',
                        currency: 'USD',
                        balanceType: 'currency',
                        icon: icons.anthropic,
                        note: ''
                    },
                    {
                        id: 'gemini',
                        name: 'Google Gemini',
                        baseUrl: 'https://generativelanguage.googleapis.com',
                        signInUrl: 'https://ai.google.dev/',
                        currency: 'USD',
                        balanceType: 'currency',
                        icon: icons.gemini,
                        note: ''
                    },
                    {
                        id: 'siliconflow',
                        name: 'ç¡…åŸºæµåŠ¨',
                        baseUrl: 'https://api.siliconflow.cn/v1',
                        signInUrl: 'https://cloud.siliconflow.cn/',
                        balanceApi: 'https://api.siliconflow.cn/v1/user/info',
                        balancePath: '',
                        balanceMethod: 'GET',
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: icons.siliconflow,
                        note: ''
                    },
                    {
                        id: 'aliyun-bailian',
                        name: 'é˜¿é‡Œäº‘ç™¾ç‚¼',
                        baseUrl: 'https://dashscope.aliyuncs.com/api/v1',
                        signInUrl: 'https://bailian.aliyun.com/',
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: icons.aliyun,
                        note: ''
                    },
                    {
                        id: 'zhipuai',
                        name: 'æ™ºè°±AI',
                        baseUrl: 'https://open.bigmodel.cn/api/paas/v4',
                        signInUrl: 'https://open.bigmodel.cn/',
                        balanceApi: 'https://open.bigmodel.cn/api/paas/v4/billing/credit_grants',
                        balancePath: 'total_balance',
                        balanceMethod: 'GET',
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: icons.zhipu,
                        note: ''
                    },
                    {
                        id: 'moonshot',
                        name: 'Moonshot',
                        baseUrl: 'https://api.moonshot.cn/v1',
                        signInUrl: 'https://platform.moonshot.cn/',
                        balanceApi: 'https://api.moonshot.cn/v1/users/me/balance',
                        balancePath: '',
                        balanceMethod: 'GET',
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: icons.moonshot,
                        note: ''
                    },
                    {
                        id: 'deepseek',
                        name: 'DeepSeek',
                        baseUrl: 'https://api.deepseek.com',
                        signInUrl: 'https://platform.deepseek.com/',
                        balanceApi: 'https://api.deepseek.com/user/balance',
                        balancePath: 'balance_infos.0.total_balance', // ğŸŸ¢ æ¢æˆæ–°çš„è·¯å¾„
                        balanceMethod: 'GET',
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: icons.deepseek,
                        note: ''
                    },
                    {
                        id: 'openrouter',
                        name: 'OpenRouter',
                        baseUrl: 'https://openrouter.ai/api/v1',
                        signInUrl: 'https://openrouter.ai/keys',
                        balanceApi: 'https://openrouter.ai/api/v1/credits',
                        balancePath: 'data.total_credits - data.total_usage', // OpenRouter çš„ä½™é¢å­—æ®µå«è¿™ä¸ª
                        balanceMethod: 'GET',
                        currency: 'USD',
                        balanceType: 'currency',
                        icon: icons.openrouter,
                        note: ''
                    },
                    {
                        id: 'minimax',
                        name: 'MiniMax',
                        baseUrl: 'https://api.minimax.chat/v1',
                        signInUrl: 'https://platform.minimaxi.com/user-center/payment/balance', // ğŸŸ¢ èŠ¥æœ«æ³¥å¹«ä½ æ›æˆäº†é¤˜é¡ç›´é”ç¶²å€
                        balanceApi: '', 
                        balancePath: 'data.total_balance', // é ç•™è·¯å¾‘
                        currency: 'CNY',
                        balanceType: 'currency',
                        icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>', 
                        note: ''
                    },
                ];

                const currentPage = ref('home');
                const apiKeys = ref([]);
                const platforms = ref([...defaultPlatforms]);
                const filterPlatform = ref('');
                const isEditMode = ref(false);
                const chartPeriod = ref('30d');
                const statsTab = ref('chart');
                const chartContainer = ref(null);
                let chart = null;

                const showDetailModal = ref(false);
                const detailKey = ref(null);
                const importFile = ref(null);
                const showAdvanced = ref(false);

                const editingNoteId = ref(null);
                const editingNoteText = ref('');

                const toast = ref({ show: false, message: '' });

                const tagInput = ref('');
                const form = ref({
                    platform: '',
                    customPlatformName: '',
                    customBalanceApi: '',
                    customBalancePath: '',
                    customBalanceMethod: 'GET',
                    name: '',
                    key: '',
                    baseUrl: '',
                    tags: [],
                    note: '',
                    balanceTotal: '',
                    balanceUsed: '',
                    currency: 'CNY',
                    signInUrl: '',
                    timeLimitAmount: '',
                    timeLimitExpire: '',
                    autoQuery: true,
                    limitReminder: '',
                    limitReminderType: 'amount',
                    editingId: null
                });

                const groupedKeys = computed(() => {
                    const groups = {};
                    const keys = filterPlatform.value
                        ? apiKeys.value.filter(k => k.platform === filterPlatform.value)
                        : apiKeys.value;

                    keys.forEach(key => {
                        const platformId = key.platform;
                        if (!groups[platformId]) {
                            const platform = platforms.value.find(p => p.id === platformId);
                            groups[platformId] = {
                                platform: platformId,
                                name: platform?.name || platformId,
                                icon: platform?.icon || icons.custom,
                                keys: []
                            };
                        }
                        groups[platformId].keys.push(key);
                    });

                    return Object.values(groups).sort((a, b) => a.name.localeCompare(b.name, 'zh'));
                });

                const platformsWithKeys = computed(() => {
                    const usedPlatformIds = new Set(apiKeys.value.map(k => k.platform));
                    return platforms.value.filter(p => usedPlatformIds.has(p.id));
                });

                const presetPlatforms = computed(() => {
                    return platforms.value.filter(p => !p.isCustom);
                });

                const savedCustomPlatforms = computed(() => {
                    return platforms.value.filter(p => p.isCustom);
                });

                const expiringCount = computed(() => {
                    return apiKeys.value.filter(key => isExpiringSoon(key)).length;
                });

                const timeLimitKeys = computed(() => {
                    return apiKeys.value
                        .filter(key => key.timeLimit && key.timeLimit.amount > 0)
                        .sort((a, b) => {
                            if (!a.timeLimit.expireAt) return 1;
                            if (!b.timeLimit.expireAt) return -1;
                            return new Date(a.timeLimit.expireAt) - new Date(b.timeLimit.expireAt);
                        });
                });

                const activePlatformCount = computed(() => {
                    const platformSet = new Set(apiKeys.value.map(k => k.platform));
                    return platformSet.size;
                });

                // ä¿®æ”¹å˜é‡å const monthlySpending -> const monthlySpendingDisplay
                // ğŸŸ¢ èŠ¥æœ«æ³¥ç‰¹è°ƒï¼šæŠŠæœ¬æœˆæ¶ˆè´¹ä¹Ÿæ‹†æˆä¸‰ä»½ï¼
                const spendingBreakdown = computed(() => {
                    const now = new Date();
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

                    let cny = 0;
                    let usd = 0;
                    let eur = 0;

                    platforms.value.forEach(platform => {
                        if (platform.unmetered) return;
                        if (!platform.balance || !platform.balance.history) return;

                        let platformUsed = 0;
                        platform.balance.history.forEach(record => {
                            const recordDate = record.date.split('T')[0];
                            if (recordDate >= firstDayOfMonth) {
                                platformUsed += record.used || 0;
                            }
                        });

                        const currency = platform.currency || platform.balance.currency || 'CNY';
                        if (currency === 'CNY') cny += platformUsed;
                        else if (currency === 'USD') usd += platformUsed;
                        else if (currency === 'EUR') eur += platformUsed;
                    });

                    let total = cny + (usd * exchangeRates.value.USD) + (eur * exchangeRates.value.EUR);

                    return {
                        total: total.toFixed(2),
                        cny: cny.toFixed(2),
                        usd: usd.toFixed(2)
                    };
                });
                // æœ¬æœˆæ¶ˆè´¹é€»è¾‘ä¿®æ”¹åˆ°è¿™
                // ä¿®æ”¹å˜é‡å const monthlySpending -> const monthlySpendingDisplay åˆ°è¿™

                // ğŸŸ¢ èŠ¥æœ«æ³¥çš„æ–°é€»è¾‘ï¼šæŠŠæ€»é¢ã€äººæ°‘å¸ã€ç¾å…ƒæ‹†å¼€ç®—
                const assetsBreakdown = computed(() => {
                    let cny = 0;
                    let usd = 0;
                    let eur = 0;

                    platformStats.value.forEach(p => {
                        const balance = p.totalRemaining || 0;
                        if (p.currency === 'CNY') cny += balance;
                        else if (p.currency === 'USD') usd += balance;
                        else if (p.currency === 'EUR') eur += balance;
                    });

                    // è®¡ç®—æŠ˜åˆäººæ°‘å¸çš„æ€»é¢
                    let total = cny + (usd * exchangeRates.value.USD) + (eur * exchangeRates.value.EUR);

                    return {
                        total: total.toFixed(2),
                        cny: cny.toFixed(2),
                        usd: usd.toFixed(2)
                    };
                });
                //  ğŸŸ¢ èŠ¥æœ«æ³¥çš„æ–°é€»è¾‘ï¼šæŠŠæ€»é¢ã€äººæ°‘å¸ã€ç¾å…ƒæ‹†å¼€ç®— åˆ°è¿™

                const platformStats = computed(() => {
                    const stats = {};
                    apiKeys.value.forEach(key => {
                        const platform = platforms.value.find(p => p.id === key.platform);
                        if (!platform || platform.unmetered) return;
                        const platformBalance = platform.balance;

                        if (!stats[key.platform]) {
                            stats[key.platform] = {
                                id: key.platform,
                                name: platform.name || key.platform,
                                icon: platform.icon || icons.custom,
                                totalRemaining: platformBalance?.remaining || 0,
                                totalUsed: platformBalance?.totalUsed || 0,
                                expiring: 0,
                                currency: platform.currency || platformBalance?.currency || 'CNY',
                                balanceType: platform.balanceType || 'currency',
                                usagePercent: platformBalance?.total ?
                                    ((platformBalance?.totalUsed || 0) / platformBalance.total * 100) : 0
                            };
                        }
                        if (isExpiringSoon(key)) stats[key.platform].expiring++;
                    });
                    return Object.values(stats).sort((a, b) => b.totalRemaining - a.totalRemaining);
                });

                const usageRanking = computed(() => {
                    const ranking = {};
                    const days = chartPeriod.value === '7d' ? 7 : chartPeriod.value === '30d' ? 30 : 90;
                    const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                    platforms.value.forEach(platform => {
                        if (platform.unmetered) return;

                        if (!ranking[platform.id]) {
                            ranking[platform.id] = {
                                platform: platform.id,
                                name: platform.name,
                                icon: platform.icon || icons.custom,
                                signInUrl: platform.signInUrl, // ğŸŸ¢ èŠ¥æœ«æ³¥æ–°å¢ï¼šæŠŠç½‘å€å¸¦è¿‡æ¥æŠ“å›¾ç‰‡
                                usage: 0,
                                currency: platform.currency || platform.balance?.currency || 'CNY'
                            };
                        }

                        if (platform.balance && platform.balance.history) {
                            platform.balance.history.forEach(record => {
                                if (record.date.split('T')[0] >= cutoff) {
                                    ranking[platform.id].usage += record.used || 0;
                                }
                            });
                        }
                    });

                    return Object.values(ranking)
                        .filter(item => item.usage > 0)
                        .sort((a, b) => b.usage - a.usage);
                });

                function getPlatformStatus(platform) {
                    if (platform.totalRemaining <= 0) return 'unknown';
                    if (platform.usagePercent > 80 || platform.expiring > 0) return 'warning';
                    return 'healthy';
                }

                function getEncryptionKey() {
                    return 'api-key-manager-2025';
                }

                function encryptKey(key) {
                    if (!key) return '';
                    return CryptoJS.AES.encrypt(key, getEncryptionKey()).toString();
                }

                function decryptKey(encryptedKey) {
                    if (!encryptedKey) return '';
                    try {
                        const bytes = CryptoJS.AES.decrypt(encryptedKey, getEncryptionKey());
                        return bytes.toString(CryptoJS.enc.Utf8) || '';
                    } catch (e) {
                        return '';
                    }
                }

                function maskKey(key) {
                    if (!key || key.length < 8) return '***';
                    return key.substring(0, 4) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + key.substring(key.length - 4);
                }

                function getPlatformName(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    return platform?.name || platformId;
                }

                function formatCurrency(value, currency = 'CNY') {
                    if (value === undefined || value === null || isNaN(value)) return '-';
                    const symbol = currency === 'CNY' ? 'Â¥' : currency === 'EUR' ? 'â‚¬' : '$';
                    return symbol + parseFloat(value).toFixed(2);
                }

                function formatBalance(value, currency = 'CNY', balanceType = 'currency') {
                    if (value === undefined || value === null || isNaN(value)) return '-';
                    if (balanceType === 'points') {
                        return parseFloat(value).toFixed(0) + ' ç§¯åˆ†';
                    }
                    return formatCurrency(value, currency);
                }

                function formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                function formatDateShort(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return (date.getMonth() + 1) + '/' + date.getDate();
                }

                function formatTimeLeft(expireAt) {
                    if (!expireAt) return 'æœªçŸ¥';
                    const expire = new Date(expireAt);
                    const now = new Date();
                    const diff = expire - now;

                    if (diff < 0) return 'å·²è¿‡æœŸ';

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                    if (days > 0) return days + 'å¤©å';
                    if (hours > 0) return hours + 'å°æ—¶å';
                    return 'å³å°†';
                }

                function isExpiringSoon(key) {
                    if (!key.timeLimit || !key.timeLimit.expireAt) return false;
                    const expire = new Date(key.timeLimit.expireAt);
                    const now = new Date();
                    const diff = expire - now;
                    return diff > 0 && diff < 48 * 60 * 60 * 1000;
                }

                function isExpired(key) {
                    if (!key.timeLimit || !key.timeLimit.expireAt) return false;
                    const expire = new Date(key.timeLimit.expireAt);
                    const now = new Date();
                    return expire < now;
                }

                function getUsagePercent(key) {
                    const platform = platforms.value.find(p => p.id === key.platform);
                    const platformTotal = platform?.balance?.total || 0;
                    const keyTotalUsed = key.totalUsed || 0;
                    if (platformTotal <= 0) return 0;
                    return Math.min(100, (keyTotalUsed / platformTotal) * 100);
                }

                function getPlatformBalance(key) {
                    const platform = platforms.value.find(p => p.id === key.platform);
                    return platform?.balance?.remaining || 0;
                }

                function getPlatformCurrency(key) {
                    const platform = platforms.value.find(p => p.id === key.platform);
                    return platform?.currency || platform?.balance?.currency || 'CNY';
                }

                function getGroupBalance(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    return platform?.balance?.remaining || 0;
                }

                function getGroupCurrency(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    return platform?.currency || platform?.balance?.currency || 'CNY';
                }

                function showToast(message) {
                    toast.value = { show: true, message };
                    setTimeout(() => toast.value.show = false, 2000);
                }

                function onPlatformChange() {
                    const platform = platforms.value.find(p => p.id === form.value.platform);
                    if (platform) {
                        form.value.baseUrl = platform.baseUrl || '';
                        form.value.signInUrl = platform.signInUrl || '';
                        form.value.currency = platform.currency || 'CNY';
                    }
                }

                function addTag() {
                    const tag = tagInput.value.trim();
                    if (tag && !form.value.tags.includes(tag)) {
                        form.value.tags.push(tag);
                    }
                    tagInput.value = '';
                }

                function removeTag(index) {
                    form.value.tags.splice(index, 1);
                }

                function cancelAdd() {
                    form.value = {
                        platform: '',
                        customPlatformName: '',
                        customBalanceApi: '',
                        customBalancePath: '',
                        customBalanceMethod: 'GET',
                        name: '',
                        key: '',
                        baseUrl: '',
                        tags: [],
                        note: '',
                        balanceTotal: '',
                        balanceUsed: '',
                        currency: 'CNY',
                        signInUrl: '',
                        timeLimitAmount: '',
                        timeLimitExpire: '',
                        autoQuery: true,
                        limitReminder: '',
                        limitReminderType: 'amount',
                        editingId: null
                    };
                    showAdvanced.value = false;
                    currentPage.value = 'home';
                }

                function saveKey() {
                    if (!form.value.platform) {
                        showToast('è¯·é€‰æ‹©å¹³å°');
                        return;
                    }
                    if (!form.value.key.trim()) {
                        showToast('è¯·è¾“å…¥ API Key');
                        return;
                    }

                    let platform = platforms.value.find(p => p.id === form.value.platform);

                    if (form.value.platform === 'custom' && form.value.customPlatformName) {
                        const customId = 'custom_' + Date.now();
                        platform = {
                            id: customId,
                            name: form.value.customPlatformName,
                            baseUrl: form.value.baseUrl || '',
                            signInUrl: form.value.signInUrl || '',
                            balanceApi: form.value.customBalanceApi || '',
                            balancePath: form.value.customBalancePath || '',
                            balanceMethod: form.value.customBalanceMethod || 'GET',
                            currency: form.value.currency || 'CNY',
                            balanceType: form.value.customBalancePath?.includes('/') ? 'points' : 'currency',
                            icon: icons.custom,
                            note: '',
                            isCustom: true
                        };
                        platforms.value.push(platform);
                        form.value.platform = customId;
                    }

                    const balanceTotal = parseFloat(form.value.balanceTotal) || 0;
                    const balanceUsed = parseFloat(form.value.balanceUsed) || 0;

                    if (platform && balanceTotal > 0 && !platform.balance?.total) {
                        platform.balance = {
                            total: balanceTotal,
                            remaining: balanceTotal - balanceUsed,
                            totalUsed: balanceUsed,
                            currency: form.value.currency,
                            lastQuery: null
                        };
                    }

                    const keyData = {
                        id: form.value.editingId || crypto.randomUUID(),
                        platform: form.value.platform,
                        customPlatformName: form.value.platform === 'custom' ? form.value.customPlatformName : undefined,
                        name: form.value.name,
                        key: encryptKey(form.value.key),
                        baseUrl: form.value.baseUrl,
                        tags: form.value.tags,
                        note: form.value.note,
                        totalUsed: 0,
                        timeLimit: form.value.timeLimitAmount ? {
                            amount: parseFloat(form.value.timeLimitAmount),
                            expireAt: form.value.timeLimitExpire ? new Date(form.value.timeLimitExpire).toISOString() : null,
                            notified: false
                        } : undefined,
                        signInUrl: form.value.signInUrl,
                        autoQuery: form.value.autoQuery,
                        limitReminder: form.value.limitReminder ? {
                            value: parseFloat(form.value.limitReminder),
                            type: form.value.limitReminderType
                        } : undefined,
                        history: [],
                        showKey: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    if (form.value.editingId) {
                        const index = apiKeys.value.findIndex(k => k.id === form.value.editingId);
                        if (index !== -1) {
                            const existingKey = apiKeys.value[index];
                            keyData.id = existingKey.id;
                            keyData.createdAt = existingKey.createdAt;
                            keyData.totalUsed = existingKey.totalUsed || 0;
                            keyData.history = existingKey.history || [];
                            keyData.lastQuery = existingKey.lastQuery;
                            keyData.updatedAt = existingKey.updatedAt;
                            apiKeys.value[index] = keyData;
                        }
                    } else {
                        apiKeys.value.push(keyData);
                    }
                    saveToStorage();

                    form.value = {
                        platform: '',
                        customPlatformName: '',
                        customBalanceApi: '',
                        customBalancePath: '',
                        customBalanceMethod: 'GET',
                        name: '',
                        key: '',
                        baseUrl: '',
                        tags: [],
                        note: '',
                        balanceTotal: '',
                        balanceUsed: '',
                        currency: 'CNY',
                        signInUrl: '',
                        timeLimitAmount: '',
                        timeLimitExpire: '',
                        autoQuery: true,
                        limitReminder: '',
                        limitReminderType: 'amount'
                    };
                    showAdvanced.value = false;

                    showToast('ä¿å­˜æˆåŠŸ');
                    currentPage.value = 'home';
                    updateChart();
                }

                function editKey(key) {
                    closeDetailModal();

                    const platform = platforms.value.find(p => p.id === key.platform);

                    form.value = {
                        platform: key.platform,
                        customPlatformName: '',
                        customBalanceApi: '',
                        customBalancePath: '',
                        customBalanceMethod: 'GET',
                        name: key.name || '',
                        key: decryptKey(key.key),
                        baseUrl: key.baseUrl || platform?.baseUrl || '',
                        tags: key.tags || [],
                        note: key.note || '',
                        balanceTotal: '',
                        balanceUsed: '',
                        currency: platform?.currency || 'CNY',
                        signInUrl: key.signInUrl || platform?.signInUrl || '',
                        timeLimitAmount: key.timeLimit?.amount || '',
                        timeLimitExpire: key.timeLimit?.expireAt ? key.timeLimit.expireAt.slice(0, 16) : '',
                        autoQuery: key.autoQuery !== false,
                        limitReminder: key.limitReminder?.value || '',
                        limitReminderType: key.limitReminder?.type || 'amount',
                        editingId: key.id
                    };

                    currentPage.value = 'add';
                }

                function deleteKey(key) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª API Key å—ï¼Ÿ')) {
                        return;
                    }
                    const index = apiKeys.value.findIndex(k => k.id === key.id);
                    if (index !== -1) {

                        // ğŸŸ¢ èŠ¥æœ«æ³¥çš„æ–°å¢é€»è¾‘ï¼šé¡ºè—¤æ‘¸ç“œï¼Œåˆ æ‰å®ƒèŠ±çš„é’±
                        const platform = platforms.value.find(p => p.id === key.platform);
                        if (platform && platform.balance && platform.balance.history) {
                            // 1. ç®—ä¸€ä¸‹è¿™ä¸ª Key åˆ°åº•èŠ±äº†å¤šå°‘é’±
                            const deletedHistory = platform.balance.history.filter(record => record.keyId === key.id);
                            const deletedAmount = deletedHistory.reduce((sum, record) => sum + (record.used || 0), 0);

                            // 2. æŠŠå±äºå®ƒçš„æ¶ˆè´¹è®°å½•ä»è´¦æœ¬é‡Œå½»åº•æ’•æ‰
                            platform.balance.history = platform.balance.history.filter(record => record.keyId !== key.id);

                            // 3. æŠŠæ€»æ¶ˆè´¹çš„é’±æ‰£å›æ¥
                            if (platform.balance.totalUsed) {
                                platform.balance.totalUsed -= deletedAmount;
                                // é˜²æ­¢å‡ºç°è´Ÿæ•°
                                if (platform.balance.totalUsed < 0) platform.balance.totalUsed = 0;
                            }
                        }
                        // ğŸŸ¢ æ–°å¢é€»è¾‘ç»“æŸ

                        apiKeys.value.splice(index, 1);
                        saveToStorage();
                        showToast('å·²åˆ é™¤');
                        updateChart();
                    }
                }

                function toggleKeyVisibility(key) {
                    key.showKey = !key.showKey;
                }

                function copyKey(key) {
                    const decrypted = decryptKey(key.key);
                    navigator.clipboard.writeText(decrypted).then(() => {
                        showToast('å·²å¤åˆ¶ Key');
                    });
                }

                function copyUrl(key) {
                    const url = key.baseUrl || platforms.value.find(p => p.id === key.platform)?.baseUrl || '';
                    if (url) {
                        navigator.clipboard.writeText(url).then(() => {
                            showToast('å·²å¤åˆ¶ URL');
                        });
                    } else {
                        showToast('æœªé…ç½® URL');
                    }
                }

                function openSignIn(key) {
                    const url = key.signInUrl || platforms.value.find(p => p.id === key.platform)?.signInUrl;
                    if (url) {
                        window.open(url, '_blank');
                    } else {
                        showToast('æœªé…ç½®ç­¾åˆ°é“¾æ¥');
                    }
                }

                function openDetailModal(key) {
                    detailKey.value = key;
                    showDetailModal.value = true;
                }

                function closeDetailModal() {
                    showDetailModal.value = false;
                    detailKey.value = null;
                }

                function startEditNote(key) {
                    editingNoteId.value = key.id;
                    editingNoteText.value = key.note || '';
                }

                function saveNote(key) {
                    key.note = editingNoteText.value;
                    key.updatedAt = new Date().toISOString();
                    editingNoteId.value = null;
                    editingNoteText.value = '';
                    saveToStorage();
                    showToast('å¤‡æ³¨å·²ä¿å­˜');
                }

                function getPlatformBalanceHistory(key) {
                    const platform = platforms.value.find(p => p.id === key.platform);
                    return platform?.balance?.history || [];
                }

                function parseBalanceValue(data, pathStr) {
                    if (!pathStr) return null;
                    pathStr = pathStr.trim();

                    // --- æ–°å¢ï¼šå¤„ç†å‡æ³•é€»è¾‘ (å¦‚ total - usage) ---
                    if (pathStr.includes('-')) {
                        const parts = pathStr.split('-');
                        const val1 = parseBalanceValue(data, parts[0].trim());
                        const val2 = parseBalanceValue(data, parts[1].trim());
                        if (val1 !== null && val2 !== null) {
                            return parseFloat(val1) - parseFloat(val2);
                        }
                        return null;
                    }

                    // --- ä¿ç•™åŸæœ‰çš„é™¤æ³•é€»è¾‘ ---
                    if (pathStr.includes('/')) {
                        const parts = pathStr.split('/');
                        const value = parseBalanceValue(data, parts[0].trim());
                        const divisor = parseFloat(parts[1].trim());
                        return (value !== null && !isNaN(divisor)) ? value / divisor : null;
                    }

                    // --- åŸæœ‰çš„è·¯å¾„æå–é€»è¾‘ (a.b.c) ---
                    const paths = pathStr.split('.');
                    let current = data;
                    for (const path of paths) {
                        current = current?.[path];
                        if (current === undefined) break;
                    }
                    return current;
                }

                // ä¿®æ”¹å‚æ•°ï¼Œå¢åŠ  keyId
                function handlePlatformBalanceChange(platform, newRemaining, keyId = null) {
                    const oldRemaining = platform.balance?.remaining;
                    const isFirstQuery = oldRemaining === undefined || oldRemaining === null;
                    const currency = platform.currency || platform.balance?.currency || 'CNY';

                    if (!platform.balance) {
                        platform.balance = {
                            total: 0,
                            remaining: 0,
                            totalUsed: 0,
                            currency: currency,
                            lastQuery: null,
                            history: []
                        };
                    }

                    if (!isFirstQuery && oldRemaining > newRemaining) {
                        const used = oldRemaining - newRemaining;
                        platform.balance.totalUsed = (platform.balance.totalUsed || 0) + used;

                        if (!platform.balance.history) platform.balance.history = [];
                        platform.balance.history.push({
                            date: new Date().toISOString(),
                            used: used,
                            balance: newRemaining,
                            keyId: keyId // ğŸŸ¢ å…³é”®æ”¹åŠ¨ï¼šç»™æ¯ç¬”æ¶ˆè´¹è®°ä¸Šæ˜¯è°èŠ±çš„
                        });
                        // ... ä¸‹é¢ä»£ç ä¿æŒä¸å˜
                    } else if (!isFirstQuery && newRemaining > oldRemaining) {
                        const diff = newRemaining - oldRemaining;
                        if (diff > 0) {
                            const name = platform.name || platform.id;
                            const defaultValue = diff.toFixed(2);
                            const input = prompt(
                                `æ£€æµ‹åˆ°å¹³å°ã€Œ${name}ã€ä½™é¢å¢åŠ ã€‚\næœ¬æ¬¡å˜åŠ¨ï¼š+${formatCurrency(diff, currency)}\nè¯·è¾“å…¥æœ¬æ¬¡å®é™…å……å€¼é‡‘é¢ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š`,
                                defaultValue
                            );
                            if (input !== null) {
                                const extra = parseFloat(input);
                                if (!isNaN(extra) && extra > 0) {
                                    platform.balance.total = (platform.balance.total || 0) + extra;
                                    platform.initialBalance = (platform.initialBalance || 0) + extra;
                                    showToast(`å·²è®°å½•å……å€¼ ${formatCurrency(extra, currency)}`);
                                }
                            }
                        }
                    }

                    platform.balance.remaining = newRemaining;
                    platform.balance.lastQuery = new Date().toISOString();
                    if (!platform.balance.currency) {
                        platform.balance.currency = currency;
                    }
                }

                async function queryBalance(key) {
                    showToast('æŸ¥è¯¢ä¸­...');

                    const platform = platforms.value.find(p => p.id === key.platform);
                    if (!platform || !platform.balanceApi) {
                        showToast('è¯¥å¹³å°ä¸æ”¯æŒè‡ªåŠ¨æŸ¥è¯¢');
                        return;
                    }

                    try {
                        const decryptedKey = decryptKey(key.key);
                        const method = platform.balanceMethod || 'GET';

                        const options = {
                            method: method,
                            headers: {
                                'Authorization': `Bearer ${decryptedKey}`,
                                'Content-Type': 'application/json'
                            }
                        };

                        const response = await fetch(platform.balanceApi, options);

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        console.log('Balance API response:', data);

                        let balance = parseBalanceValue(data, platform.balancePath);

                        if (balance === null || balance === undefined) {
                            balance = data?.data?.data?.balance ??
                                data?.data?.data?.totalBalance ??
                                data?.data?.balance ??
                                data?.data?.totalBalance ??
                                data?.balance ??
                                data?.totalBalance ??
                                data?.data?.available_balance ??
                                data?.available_balance;
                        }

                        if (balance !== null && balance !== undefined) {
                            const newRemaining = parseFloat(balance);
                            const currency = platform.currency || platform.balance?.currency || 'CNY';

                            handlePlatformBalanceChange(platform, newRemaining, key.id);

                            saveToStorage();
                            showToast('ä½™é¢å·²æ›´æ–°: ' + formatCurrency(newRemaining, currency));
                            updateChart();
                        } else {
                            showToast('æ— æ³•è§£æä½™é¢æ•°æ®');
                            console.log('Response structure:', JSON.stringify(data, null, 2));
                        }
                    } catch (error) {
                        showToast('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                        console.error('Balance query error:', error);
                    }
                }

                async function queryAllBalances() {
                    const platformKeys = new Map();

                    for (const key of apiKeys.value) {
                        if (key.autoQuery === false) continue;
                        const platform = platforms.value.find(p => p.id === key.platform);
                        if (!platform || !platform.balanceApi) continue;

                        if (!platformKeys.has(key.platform)) {
                            platformKeys.set(key.platform, key);
                        }
                    }

                    if (platformKeys.size === 0) return;

                    showToast(`æ­£åœ¨æŸ¥è¯¢ ${platformKeys.size} ä¸ªå¹³å°çš„ä½™é¢...`);

                    let successCount = 0;
                    let failCount = 0;

                    for (const [platformId, key] of platformKeys) {
                        const platform = platforms.value.find(p => p.id === platformId);
                        if (!platform || !platform.balanceApi) continue;

                        try {
                            const decryptedKey = decryptKey(key.key);
                            const method = platform.balanceMethod || 'GET';

                            const options = {
                                method: method,
                                headers: {
                                    'Authorization': `Bearer ${decryptedKey}`,
                                    'Content-Type': 'application/json'
                                }
                            };

                            const response = await fetch(platform.balanceApi, options);

                            if (!response.ok) {
                                failCount++;
                                continue;
                            }

                            const data = await response.json();
                            let balance = parseBalanceValue(data, platform.balancePath);

                            if (balance === null || balance === undefined) {
                                balance = data?.data?.data?.balance ??
                                    data?.data?.data?.totalBalance ??
                                    data?.data?.balance ??
                                    data?.data?.totalBalance ??
                                    data?.balance ??
                                    data?.totalBalance ??
                                    data?.data?.available_balance ??
                                    data?.available_balance;
                            }

                            if (balance !== null && balance !== undefined) {
                                const newRemaining = parseFloat(balance);

                                handlePlatformBalanceChange(platform, newRemaining, key.id);
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            failCount++;
                            console.error('Balance query error:', error);
                        }
                    }

                    saveToStorage();
                    updateChart();

                    if (successCount > 0 || failCount > 0) {
                        showToast(`ä½™é¢æ›´æ–°å®Œæˆ: ${successCount} æˆåŠŸ, ${failCount} å¤±è´¥`);
                    }
                }

                async function refreshAllBalances() {
                    const platformKeys = new Map();

                    for (const key of apiKeys.value) {
                        const platform = platforms.value.find(p => p.id === key.platform);
                        if (!platform || !platform.balanceApi) continue;

                        if (!platformKeys.has(key.platform)) {
                            platformKeys.set(key.platform, key);
                        }
                    }

                    if (platformKeys.size === 0) {
                        showToast('æ²¡æœ‰æ”¯æŒè‡ªåŠ¨æŸ¥è¯¢çš„å¹³å°');
                        return;
                    }

                    showToast(`æ­£åœ¨åˆ·æ–° ${platformKeys.size} ä¸ªå¹³å°çš„ä½™é¢...`);

                    let successCount = 0;
                    let failCount = 0;

                    for (const [platformId, key] of platformKeys) {
                        const platform = platforms.value.find(p => p.id === platformId);
                        if (!platform || !platform.balanceApi) continue;

                        try {
                            const decryptedKey = decryptKey(key.key);
                            const method = platform.balanceMethod || 'GET';

                            const options = {
                                method: method,
                                headers: {
                                    'Authorization': `Bearer ${decryptedKey}`,
                                    'Content-Type': 'application/json'
                                }
                            };

                            const response = await fetch(platform.balanceApi, options);

                            if (!response.ok) {
                                failCount++;
                                continue;
                            }

                            const data = await response.json();
                            let balance = parseBalanceValue(data, platform.balancePath);

                            if (balance === null || balance === undefined) {
                                balance = data?.data?.data?.balance ??
                                    data?.data?.data?.totalBalance ??
                                    data?.data?.balance ??
                                    data?.data?.totalBalance ??
                                    data?.balance ??
                                    data?.totalBalance ??
                                    data?.data?.available_balance ??
                                    data?.available_balance;
                            }

                            if (balance !== null && balance !== undefined) {
                                const newRemaining = parseFloat(balance);

                                handlePlatformBalanceChange(platform, newRemaining, key.id);
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } catch (error) {
                            failCount++;
                            console.error('Balance query error:', error);
                        }
                    }

                    saveToStorage();
                    updateChart();

                    async function fetchExchangeRates() {
                        try {
                            // è·å–ä»¥ç¾å…ƒä¸ºåŸºå‡†çš„æœ€æ–°æ±‡ç‡
                            const response = await fetch('https://open.er-api.com/v6/latest/USD');
                            const data = await response.json();
                            if (data && data.rates) {
                                exchangeRates.value.USD = data.rates.CNY;
                                // äº¤å‰è®¡ç®—æ¬§å…ƒå¯¹äººæ°‘å¸æ±‡ç‡
                                const eurToUsd = data.rates.EUR;
                                exchangeRates.value.EUR = data.rates.CNY / eurToUsd;
                                console.log('æœ€æ–°æ±‡ç‡å·²æ›´æ–°:', exchangeRates.value);
                            }
                        } catch (e) {
                            console.error('æ±‡ç‡è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ±‡ç‡', e);
                        }
                    }



                    showToast(`ä½™é¢æ›´æ–°å®Œæˆ: ${successCount} æˆåŠŸ, ${failCount} å¤±è´¥`);
                }

                function exportData() {
                    const data = {
                        apiKeys: apiKeys.value,
                        platforms: platforms.value,
                        exportDate: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `api-keys-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('å¯¼å‡ºæˆåŠŸ');
                }

                function triggerImport() {
                    importFile.value.click();
                }

                function importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.apiKeys) {
                                apiKeys.value = data.apiKeys;
                                if (data.platforms) {
                                    platforms.value = data.platforms;
                                }
                                saveToStorage();
                                showToast('å¯¼å…¥æˆåŠŸ');
                                updateChart();
                            }
                        } catch (error) {
                            showToast('å¯¼å…¥å¤±è´¥');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                }

                function clearAllData() {
                    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
                    if (!confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ API Key å’Œå¹³å°æ•°æ®ï¼')) return;

                    apiKeys.value = [];
                    platforms.value.forEach(p => {
                        if (p.balance) delete p.balance;
                        p.note = '';
                    });
                    localStorage.removeItem('apiKeys');
                    saveToStorage();
                    showToast('æ•°æ®å·²æ¸…ç©º');
                    updateChart();
                }

                function getPlatformInitialBalance(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    return platform?.initialBalance || 0;
                }

                function getPlatformUsage(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    if (!platform || !platform.balance) return 0;
                    if (platform.initialBalance) {
                        return Math.max(0, platform.initialBalance - platform.balance.remaining);
                    }
                    return 0;
                }

                function openPlatformSettings(platformId) {
                    const platform = platforms.value.find(p => p.id === platformId);
                    if (!platform) return;
                    // å…‹éš†ä¸€ä»½æ•°æ®ç”¨äºç¼–è¾‘
                    currentPlatform.value = JSON.parse(JSON.stringify(platform));
                    // ç¡®ä¿ initialBalance ä¸ºæ•°å­—
                    if (!currentPlatform.value.initialBalance) currentPlatform.value.initialBalance = '';
                    showPlatformModal.value = true;
                }

                function closePlatformModal() {
                    showPlatformModal.value = false;
                    currentPlatform.value = {};
                }

                function savePlatformSettings() {
                    const index = platforms.value.findIndex(p => p.id === currentPlatform.value.id);
                    if (index !== -1) {
                        const platform = platforms.value[index];
                        platform.name = currentPlatform.value.name || platform.name;
                        platform.initialBalance = Number(currentPlatform.value.initialBalance) || 0;
                        platform.note = currentPlatform.value.note || '';
                        platform.unmetered = !!currentPlatform.value.unmetered;
                        saveToStorage();
                        showToast('å¹³å°è®¾ç½®å·²ä¿å­˜');
                    }
                    closePlatformModal();
                }

                function deleteCurrentPlatform() {
                    if (!currentPlatform.value || !currentPlatform.value.id) return;
                    const platformId = currentPlatform.value.id;
                    const platform = platforms.value.find(p => p.id === platformId);
                    if (!platform || !platform.isCustom) {
                        showToast('ä»…æ”¯æŒåˆ é™¤è‡ªå®šä¹‰å¹³å°');
                        return;
                    }
                    const relatedKeys = apiKeys.value.filter(k => k.platform === platformId);
                    const keyCount = relatedKeys.length;
                    let message = 'ç¡®å®šè¦åˆ é™¤æ­¤è‡ªå®šä¹‰å¹³å°å—ï¼Ÿ';
                    if (keyCount > 0) {
                        message += `\nåŒæ—¶å°†åˆ é™¤ ${keyCount} ä¸ªå…³è”çš„ API Keyã€‚`;
                    }
                    if (!confirm(message)) return;

                    apiKeys.value = apiKeys.value.filter(k => k.platform !== platformId);
                    const index = platforms.value.findIndex(p => p.id === platformId);
                    if (index !== -1) {
                        platforms.value.splice(index, 1);
                    }
                    saveToStorage();
                    showToast('å¹³å°å·²åˆ é™¤');
                    currentPlatform.value = {};
                    showPlatformModal.value = false;
                    updateChart();
                }

                function saveToStorage() {
                    localStorage.setItem('apiKeys', JSON.stringify(apiKeys.value));
                    localStorage.setItem('platforms', JSON.stringify(platforms.value));
                }

                function loadFromStorage() {
                    const keys = localStorage.getItem('apiKeys');
                    const plats = localStorage.getItem('platforms');

                    if (keys) {
                        try { apiKeys.value = JSON.parse(keys); } catch (e) { }
                    }
                    if (plats) {
                        try {
                            const savedPlatforms = JSON.parse(plats);
                            savedPlatforms.forEach(sp => {
                                const platform = platforms.value.find(p => p.id === sp.id);
                                if (platform) {
                                    platform.unmetered = !!sp.unmetered;
                                    if (sp.note) platform.note = sp.note;
                                    if (sp.balance) platform.balance = sp.balance;
                                    if (sp.icon && sp.isCustom) platform.icon = sp.icon;
                                    if (sp.initialBalance) platform.initialBalance = sp.initialBalance;
                                }
                            });
                        } catch (e) { }
                    }
                }

                function initChart() {
                    if (!chartContainer.value) {
                        setTimeout(initChart, 100);
                        return;
                    }
                    if (chart) {
                        chart.dispose();
                        chart = null;
                    }
                    try {
                        chart = echarts.init(chartContainer.value);
                        updateChart();
                        window.addEventListener('resize', () => {
                            if (chart) chart.resize();
                        });
                    } catch (e) {
                        console.error('Chart init error:', e);
                    }
                }

                function updateChart() {
                    if (!chart) return;

                    const days = chartPeriod.value === '7d' ? 7 : chartPeriod.value === '30d' ? 30 : 90;
                    const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                    const platformUsage = [];

                    platforms.value.forEach(platform => {
                        if (platform.unmetered) return;
                        if (!platform.balance || !platform.balance.history) return;

                        let usage = 0;
                        platform.balance.history.forEach(record => {
                            const recordDate = record.date.split('T')[0];
                            if (recordDate >= cutoff) {
                                usage += record.used || 0;
                            }
                        });

                        if (usage > 0) {
                            platformUsage.push({
                                name: platform.name,
                                value: usage,
                                icon: platform.icon || icons.custom
                            });
                        }
                    });

                    const pieData = platformUsage.sort((a, b) => b.value - a.value);

                    const colors = ['#007AFF', '#34C759', '#FF9500', '#FF3B30', '#5856D6', '#FF2D55', '#AF52DE', '#00C7BE'];

                    if (pieData.length === 0) {
                        chart.setOption({
                            backgroundColor: 'transparent',
                            title: {
                                text: 'æš‚æ— ç”¨é‡æ•°æ®',
                                left: 'center',
                                top: 'center',
                                textStyle: { color: '#999', fontSize: 14 }
                            }
                        });
                        return;
                    }

                    chart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: '#fff',
                            borderColor: '#e0e0e0',
                            textStyle: { color: '#1a1a1a', fontSize: 12 },
                            formatter: (params) => {
                                return `${params.name}<br/>${formatCurrency(params.value, 'CNY')} (${params.percent}%)`;
                            }
                        },
                        legend: {
                            orient: 'vertical',
                            right: 10,
                            top: 'center',
                            textStyle: { color: '#666', fontSize: 12 }
                        },
                        series: [{
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['35%', '50%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 8,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 14,
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: pieData.map((item, index) => ({
                                name: item.name,
                                value: item.value,
                                itemStyle: { color: colors[index % colors.length] }
                            }))
                        }]
                    });
                }

                watch(chartPeriod, updateChart);
                watch([currentPage, statsTab], () => {
                    if (currentPage.value === 'stats' && statsTab.value === 'chart') {
                        nextTick(() => {
                            initChart();
                        });
                    }
                });

                onMounted(() => {
                    loadFromStorage();
                    fetchExchangeRates(); // æ–°å¢ï¼šè·å–æœ€æ–°æ±‡ç‡
                    setTimeout(() => {
                        queryAllBalances();
                    }, 500);
                });

                return {
                    icons,
                    themeColor,  //å¢åŠ é¢œè‰²å˜é‡
                    customBg,       // ğŸŸ¢ é¢œè‰²å˜é‡å’ŒèƒŒæ™¯å›¾å˜é‡
                    handleBgUpload, // ğŸŸ¢ 
                    clearBg,        // ğŸŸ¢
                    platformsWithKeys, // è¡¥ä¸Šè¿™ä¸ªï¼Œè§£å†³æ§åˆ¶å°é‚£ä¸ªé»„è‰²è­¦å‘Š
                    currentMonth,   // ğŸŸ¢ åŠ è¿™è¡Œ æ—¥å†åŠŸèƒ½å˜é‡
                    prevMonth,      // ğŸŸ¢ åŠ è¿™è¡Œ
                    nextMonth,      // ğŸŸ¢ åŠ è¿™è¡Œ
                    calendarData,   // ğŸŸ¢ åŠ è¿™è¡Œ
                    statsTab,//åˆ‡æ¢å¼€å…³å˜é‡
                    exchangeRates,
                    fetchExchangeRates,
                    currentPage,
                    apiKeys,
                    platforms,
                    presetPlatforms,
                    savedCustomPlatforms,
                    filterPlatform,
                    isEditMode,
                    chartPeriod,
                    chartContainer,
                    showDetailModal,
                    detailKey,
                    importFile,
                    showAdvanced,
                    editingNoteId,
                    editingNoteText,
                    toast,
                    tagInput,
                    form,
                    groupedKeys,
                    expiringCount,
                    timeLimitKeys,
                    activePlatformCount,
                    // æ”¹äº†å˜é‡å monthlySpending-> monthlySpendingDisplay
                    spendingBreakdown, //æ”¹äº†å˜é‡å monthlySpendingDisplay-> spendingBreakdown
                    assetsBreakdown,   //æ”¹äº†å˜é‡å totalAssetsDisplay-> assetsBreakdown
                    platformStats,
                    usageRanking,
                    getPlatformStatus,
                    decryptKey,
                    maskKey,
                    getPlatformName,
                    formatCurrency,
                    formatBalance,
                    isExpired,
                    formatDate,
                    formatDateShort,
                    formatTimeLeft,
                    isExpiringSoon,
                    getUsagePercent,
                    getPlatformBalance,
                    getPlatformCurrency,
                    getGroupBalance,
                    getGroupCurrency,
                    getPlatformBalanceHistory,
                    onPlatformChange,
                    addTag,
                    removeTag,
                    cancelAdd,
                    saveKey,
                    editKey,
                    deleteKey,
                    toggleKeyVisibility,
                    copyKey,
                    copyUrl,
                    openSignIn,
                    openDetailModal,
                    closeDetailModal,
                    startEditNote,
                    saveNote,
                    queryBalance,
                    queryAllBalances,
                    refreshAllBalances,
                    exportData,
                    triggerImport,
                    importData,
                    clearAllData,
                    expandedPlatforms,
                    togglePlatform,
                    showPlatformModal,
                    currentPlatform,
                    getPlatformInitialBalance,
                    getPlatformUsage,
                    openPlatformSettings,
                    closePlatformModal,
                    savePlatformSettings,
                    deleteCurrentPlatform
                };
            }
        }).mount('#app');
        // å¢åŠ äº†emojiæ‰è½çš„æ•ˆæœ
        // ğŸŸ¢ èŠ¥æœ«æ³¥çš„é­”æ³•ï¼šå…¨å±€ç‚¹å‡»æ‰è½è¡¨æƒ…åŒ…ç‰¹æ•ˆ
        document.addEventListener('click', function (e) {
            // è¿™é‡Œæ˜¯ä½ ä¸“å±çš„è¡¨æƒ…åŒ…åº“ï¼Œå¯ä»¥éšä¾¿å¾€é‡ŒåŠ å–œæ¬¢çš„ emojiï¼
            const emojis = ['âœ¨', 'ğŸ’–', 'ğŸŒ¸', 'ğŸ¬', 'ğŸ€', 'ğŸª„', 'â­', 'ğŸ“'];
            const emoji = document.createElement('div');
            emoji.className = 'magic-emoji';
            emoji.innerText = emojis[Math.floor(Math.random() * emojis.length)];

            // è®©è¡¨æƒ…ä»ä½ ç‚¹å‡»çš„æŒ‡å°–ä¸­å¿ƒå†’å‡ºæ¥
            emoji.style.left = (e.clientX - 11) + 'px';
            emoji.style.top = (e.clientY - 11) + 'px';
            document.body.appendChild(emoji);

            // 800æ¯«ç§’ååŠ¨ç”»ç»“æŸï¼Œé™é™åœ°æŠŠå®ƒæ‰«èµ°
            setTimeout(() => {
                emoji.remove();
            }, 800);
        });
        // åˆ°è¿™
    </script>
</body>

</html>